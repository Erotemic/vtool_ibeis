<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vtool.matching &mdash; wbia-vtool 4.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> wbia-vtool
          </a>
              <div class="version">
                4.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vtool.html">vtool package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wbia-vtool</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>vtool.matching</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vtool.matching</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    vt</span>
<span class="sd">    python -m utool.util_inspect check_module_usage --pat=&quot;matching.py&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">_rhomb_dist</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">ubelt</span> <span class="k">as</span> <span class="nn">ub</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">parse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">.util_math</span> <span class="kn">import</span> <span class="n">TAU</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyhesaff</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pyhesaff</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">pass</span>


<span class="n">AssignTup</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;AssignTup&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;fm&#39;</span><span class="p">,</span> <span class="s1">&#39;match_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;norm_fx1&#39;</span><span class="p">,</span> <span class="s1">&#39;norm_dist&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="MatchingError"><a class="viewcode-back" href="../../vtool.html#vtool.matching.MatchingError">[docs]</a><span class="k">class</span> <span class="nc">MatchingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="k">if</span> <span class="n">pyhesaff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">VSONE_FEAT_CONFIG</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pyhesaff</span><span class="o">.</span><span class="n">get_hesaff_default_params</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">VSONE_FEAT_CONFIG</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">VSONE_ASSIGN_CONFIG</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;symmetric&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;fgweights&#39;</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;Knorm&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">VSONE_RATIO_CONFIG</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;ratio_thresh&#39;</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
<span class="p">]</span>


<span class="n">VSONE_SVER_CONFIG</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;sv_on&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;thresh_bins&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(),</span> <span class="n">type_</span><span class="o">=</span><span class="nb">eval</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sv_on&#39;</span><span class="p">]),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
        <span class="s1">&#39;refine_method&#39;</span><span class="p">,</span>
        <span class="s1">&#39;homog&#39;</span><span class="p">,</span>
        <span class="n">valid_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;homog&#39;</span><span class="p">,</span> <span class="s1">&#39;affine&#39;</span><span class="p">],</span>
        <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sv_on&#39;</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
        <span class="s1">&#39;sver_xy_thresh&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sv_on&#39;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
        <span class="s1">&#39;sver_ori_thresh&#39;</span><span class="p">,</span>
        <span class="n">TAU</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span>
        <span class="n">min_</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">max_</span><span class="o">=</span><span class="n">TAU</span><span class="p">,</span>
        <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sv_on&#39;</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span>
        <span class="s1">&#39;sver_scale_thresh&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;sv_on&#39;</span><span class="p">]</span>
    <span class="p">),</span>
<span class="p">]</span>


<span class="n">NORM_CHIP_CONFIG</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ---</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;histeq&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="c1"># ---</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;adapteq&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;adapteq_ksize&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;adapteq&#39;</span><span class="p">]),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;adapteq_limit&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;adapteq&#39;</span><span class="p">]),</span>
    <span class="c1"># ---</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;medianblur&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;medianblur_thresh&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;medianblur&#39;</span><span class="p">]),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;medianblur_ksize1&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;medianblur&#39;</span><span class="p">]),</span>
    <span class="n">ut</span><span class="o">.</span><span class="n">ParamInfo</span><span class="p">(</span><span class="s1">&#39;medianblur_ksize2&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">hideif</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cfg</span><span class="p">:</span> <span class="ow">not</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;medianblur&#39;</span><span class="p">]),</span>
    <span class="c1"># ---</span>
<span class="p">]</span>


<span class="n">VSONE_DEFAULT_CONFIG</span> <span class="o">=</span> <span class="n">VSONE_ASSIGN_CONFIG</span> <span class="o">+</span> <span class="n">VSONE_RATIO_CONFIG</span> <span class="o">+</span> <span class="n">VSONE_SVER_CONFIG</span>

<span class="n">VSONE_PI_DICT</span> <span class="o">=</span> <span class="p">{</span><span class="n">pi</span><span class="o">.</span><span class="n">varname</span><span class="p">:</span> <span class="n">pi</span> <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="n">VSONE_DEFAULT_CONFIG</span><span class="p">}</span>


<div class="viewcode-block" id="demodata_match"><a class="viewcode-back" href="../../vtool.html#vtool.matching.demodata_match">[docs]</a><span class="k">def</span> <span class="nf">demodata_match</span><span class="p">(</span><span class="n">cfgdict</span><span class="o">=</span><span class="p">{},</span> <span class="n">apply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recompute</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>
    <span class="kn">from</span> <span class="nn">vtool.inspect_matches</span> <span class="kn">import</span> <span class="n">lazy_test_annot</span>

    <span class="c1"># hashid based on the state of the code</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">apply</span><span class="p">:</span>
        <span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">function_sig</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_func_sourcecode</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">matching</span><span class="o">.</span><span class="n">PairwiseMatch</span><span class="p">)</span>
    <span class="n">hashid</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">hash_data</span><span class="p">(</span><span class="n">function_sig</span><span class="p">)</span>
    <span class="n">ub</span><span class="o">.</span><span class="n">util_hash</span><span class="o">.</span><span class="n">_HASHABLE_EXTENSIONS</span><span class="o">.</span><span class="n">_register_agressive_extensions</span><span class="p">()</span>
    <span class="n">cfgstr</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">hash_data</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">)</span> <span class="o">+</span> <span class="n">hashid</span>
    <span class="n">cacher</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">Cacher</span><span class="p">(</span><span class="s1">&#39;test_match_v5&#39;</span><span class="p">,</span> <span class="n">cfgstr</span><span class="o">=</span><span class="n">cfgstr</span><span class="p">,</span> <span class="n">appname</span><span class="o">=</span><span class="s1">&#39;vtool&#39;</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="n">use_cache</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">cacher</span><span class="o">.</span><span class="n">tryload</span><span class="p">()</span>
    <span class="n">annot1</span> <span class="o">=</span> <span class="n">lazy_test_annot</span><span class="p">(</span><span class="s1">&#39;easy1.png&#39;</span><span class="p">)</span>
    <span class="n">annot2</span> <span class="o">=</span> <span class="n">lazy_test_annot</span><span class="p">(</span><span class="s1">&#39;easy2.png&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">recompute</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">PairwiseMatch</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">annot2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="n">match</span><span class="o">.</span><span class="n">apply_all</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">)</span>
        <span class="n">cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match</span><span class="o">.</span><span class="n">annot1</span> <span class="o">=</span> <span class="n">annot1</span>
        <span class="n">match</span><span class="o">.</span><span class="n">annot2</span> <span class="o">=</span> <span class="n">annot2</span>
    <span class="k">return</span> <span class="n">match</span></div>


<div class="viewcode-block" id="PairwiseMatch"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch">[docs]</a><span class="k">class</span> <span class="nc">PairwiseMatch</span><span class="p">(</span><span class="n">ub</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Newest (Sept-16-2016) object oriented one-vs-one matching interface</span>

<span class="sd">    Creates an object holding two annotations</span>
<span class="sd">    Then a pipeline of operations can be applied to</span>
<span class="sd">    generate score and refine the matches</span>

<span class="sd">    Note:</span>
<span class="sd">        The annotation dictionaries are required to have certain attributes.</span>

<span class="sd">        Required annotation attributes:</span>
<span class="sd">            (kpts, vecs) OR rchip OR rchip_fpath</span>

<span class="sd">        Optional annotation attributes:</span>
<span class="sd">            aid, nid, flann, rchip, dlen_sqrd, weight</span>

<span class="sd">    Ignore:</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">        &gt;&gt;&gt; imgR = vt.imread(ut.grab_test_imgpath(&#39;easy1.png&#39;))</span>
<span class="sd">        &gt;&gt;&gt; imgL = vt.imread(ut.grab_test_imgpath(&#39;easy2.png&#39;))</span>
<span class="sd">        &gt;&gt;&gt; annot1 = {&#39;rchip&#39;: imgR}</span>
<span class="sd">        &gt;&gt;&gt; annot2 = {&#39;rchip&#39;: imgL}</span>
<span class="sd">        &gt;&gt;&gt; match = vt.PairwiseMatch(annot1, annot2)</span>
<span class="sd">        &gt;&gt;&gt; match.apply_all({&#39;refine_method&#39;: &#39;affine&#39;, &#39;affine_invariance&#39;: False, &#39;rotation_invariance&#39;: False})</span>
<span class="sd">        &gt;&gt;&gt; dsize = imgR.shape[0:2][::-1]</span>
<span class="sd">        &gt;&gt;&gt; imgR_warp = vt.warpHomog(imgR, match.H_12, dsize)</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">        &gt;&gt;&gt; import kwplot</span>
<span class="sd">        &gt;&gt;&gt; kwplot.autompl()</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgL, pnum=(2, 1, 1))</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgR_warp, pnum=(2, 1, 2))</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgL, pnum=(2, 1, 1))</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgR_warp, pnum=(2, 1, 2))</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--gui)</span>
<span class="sd">        &gt;&gt;&gt; import wbia.guitool as gt</span>
<span class="sd">        &gt;&gt;&gt; gt.ensure_qapp()</span>
<span class="sd">        &gt;&gt;&gt; match.ishow()</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">        &gt;&gt;&gt; imgR = vt.imread(ut.grab_test_imgpath(&#39;easy1.png&#39;))</span>
<span class="sd">        &gt;&gt;&gt; imgL = vt.imread(ut.grab_test_imgpath(&#39;easy2.png&#39;))</span>
<span class="sd">        &gt;&gt;&gt; annot1 = {&#39;rchip&#39;: imgR}</span>
<span class="sd">        &gt;&gt;&gt; annot2 = {&#39;rchip&#39;: imgL}</span>
<span class="sd">        &gt;&gt;&gt; match = vt.PairwiseMatch(annot1, annot2)</span>
<span class="sd">        &gt;&gt;&gt; match.apply_all({&#39;refine_method&#39;: &#39;affine&#39;, &#39;affine_invariance&#39;: False, &#39;rotation_invariance&#39;: False})</span>
<span class="sd">        &gt;&gt;&gt; dsize = imgR.shape[0:2][::-1]</span>
<span class="sd">        &gt;&gt;&gt; imgR_warp = vt.warpHomog(imgR, match.H_12, dsize)</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">        &gt;&gt;&gt; import kwplot</span>
<span class="sd">        &gt;&gt;&gt; kwplot.autompl()</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgL, pnum=(2, 1, 1))</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgR_warp, pnum=(2, 1, 2))</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgL, pnum=(2, 1, 1))</span>
<span class="sd">        &gt;&gt;&gt; kwplot.imshow(imgR_warp, pnum=(2, 1, 2))</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--gui)</span>
<span class="sd">        &gt;&gt;&gt; import wbia.guitool as gt</span>
<span class="sd">        &gt;&gt;&gt; gt.ensure_qapp()</span>
<span class="sd">        &gt;&gt;&gt; match.ishow()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">annot1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annot2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">):</span>
            <span class="n">annot1</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">(</span><span class="n">annot1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot2</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">):</span>
            <span class="n">annot2</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">(</span><span class="n">annot2</span><span class="p">)</span>

        <span class="n">match</span><span class="o">.</span><span class="n">annot1</span> <span class="o">=</span> <span class="n">annot1</span>
        <span class="n">match</span><span class="o">.</span><span class="n">annot2</span> <span class="o">=</span> <span class="n">annot2</span>
        <span class="n">match</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">match</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">match</span><span class="o">.</span><span class="n">H_21</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">match</span><span class="o">.</span><span class="n">H_12</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">match</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">odict</span><span class="p">([])</span>
        <span class="n">match</span><span class="o">.</span><span class="n">global_measures</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">odict</span><span class="p">([])</span>
        <span class="n">match</span><span class="o">.</span><span class="n">_inplace_default</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_available_params</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">VSONE_PI_DICT</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_take_params</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        take parameter info from config using default values defined in module</span>
<span class="sd">        constants.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if isinstance(keys, six.string_types):</span>
        <span class="c1">#     keys = keys.split(&#39;, &#39;)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config</span> <span class="k">else</span> <span class="n">VSONE_PI_DICT</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>

    <span class="k">def</span> <span class="nf">__nice__</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;aid&#39;</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">:</span>
            <span class="n">aid1</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span>
            <span class="n">aid2</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span>
            <span class="n">vsstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-vs-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid1</span><span class="p">,</span> <span class="n">aid2</span><span class="p">)</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vsstr</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;None&#39;</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The state of Pariwise Match ignores most of the annotation objects.</span>

<span class="sd">        This means that if you need properties of annots, you must reapply</span>
<span class="sd">        them after you load a PairwiseMatch object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_prepare_annot</span><span class="p">(</span><span class="n">annot</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">):</span>
                <span class="n">_annot</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s1">&#39;aid&#39;</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>
                    <span class="n">_annot</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s1">&#39;aid&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">_annot</span>
            <span class="k">return</span> <span class="n">annot</span>

        <span class="n">_annot1</span> <span class="o">=</span> <span class="n">_prepare_annot</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">)</span>
        <span class="n">_annot2</span> <span class="o">=</span> <span class="n">_prepare_annot</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">)</span>

        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;annot1&#39;</span><span class="p">:</span> <span class="n">_annot1</span><span class="p">,</span>
            <span class="s1">&#39;annot2&#39;</span><span class="p">:</span> <span class="n">_annot2</span><span class="p">,</span>
            <span class="s1">&#39;fm&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">,</span>
            <span class="s1">&#39;fs&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span>
            <span class="s1">&#39;H_21&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">H_21</span><span class="p">,</span>
            <span class="s1">&#39;H_12&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">H_12</span><span class="p">,</span>
            <span class="s1">&#39;global_measures&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">global_measures</span><span class="p">,</span>
            <span class="s1">&#39;local_measures&#39;</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">match</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">match</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="PairwiseMatch.show"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span>
        <span class="n">match</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show_homog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_ori</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_ell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">show_pts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">show_rect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_eig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_all_kpts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mask_blend</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ell_alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">line_alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
        <span class="n">modifysize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">vert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">heatmask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">line_lw</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] show&#39;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">annot1</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span>
        <span class="n">annot2</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rchip1</span> <span class="o">=</span> <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;nchip&#39;</span><span class="p">]</span>
            <span class="n">rchip2</span> <span class="o">=</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;nchip&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: nchip not set. fallback to rchip&#39;</span><span class="p">)</span>
            <span class="n">rchip1</span> <span class="o">=</span> <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;rchip&#39;</span><span class="p">]</span>
            <span class="n">rchip2</span> <span class="o">=</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;rchip&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">overlay</span><span class="p">:</span>
            <span class="n">kpts1</span> <span class="o">=</span> <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span>
            <span class="n">kpts2</span> <span class="o">=</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kpts1</span> <span class="o">=</span> <span class="n">kpts2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">show_homog</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">show_ori</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">show_ell</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">show_pts</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">show_lines</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">show_rect</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">show_eig</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># show_all_kpts = False</span>
            <span class="c1"># mask_blend = 0</span>

        <span class="k">if</span> <span class="n">mask_blend</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

            <span class="n">mask1</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;probchip_img&#39;</span><span class="p">],</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_size</span><span class="p">(</span><span class="n">rchip1</span><span class="p">))</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;probchip_img&#39;</span><span class="p">],</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_size</span><span class="p">(</span><span class="n">rchip2</span><span class="p">))</span>
            <span class="c1"># vt.blend_images_average(vt.mask1, 1.0, alpha=mask_blend)</span>
            <span class="n">rchip1</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">blend_images_mult_average</span><span class="p">(</span><span class="n">rchip1</span><span class="p">,</span> <span class="n">mask1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">mask_blend</span><span class="p">)</span>
            <span class="n">rchip2</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">blend_images_mult_average</span><span class="p">(</span><span class="n">rchip2</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">mask_blend</span><span class="p">)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fs</span>

        <span class="n">H1</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">H_12</span> <span class="k">if</span> <span class="n">show_homog</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># H2 = match.H_21 if show_homog else None</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">xywh1</span><span class="p">,</span> <span class="n">xywh2</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">show_chipmatch2</span><span class="p">(</span>
            <span class="n">rchip1</span><span class="p">,</span>
            <span class="n">rchip2</span><span class="p">,</span>
            <span class="n">kpts1</span><span class="p">,</span>
            <span class="n">kpts2</span><span class="p">,</span>
            <span class="n">fm</span><span class="p">,</span>
            <span class="n">fs</span><span class="p">,</span>
            <span class="n">colorbar_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">H1</span><span class="o">=</span><span class="n">H1</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">modifysize</span><span class="o">=</span><span class="n">modifysize</span><span class="p">,</span>
            <span class="n">ori</span><span class="o">=</span><span class="n">show_ori</span><span class="p">,</span>
            <span class="n">rect</span><span class="o">=</span><span class="n">show_rect</span><span class="p">,</span>
            <span class="n">eig</span><span class="o">=</span><span class="n">show_eig</span><span class="p">,</span>
            <span class="n">ell</span><span class="o">=</span><span class="n">show_ell</span><span class="p">,</span>
            <span class="n">pts</span><span class="o">=</span><span class="n">show_pts</span><span class="p">,</span>
            <span class="n">draw_lines</span><span class="o">=</span><span class="n">show_lines</span><span class="p">,</span>
            <span class="n">all_kpts</span><span class="o">=</span><span class="n">show_all_kpts</span><span class="p">,</span>
            <span class="n">line_alpha</span><span class="o">=</span><span class="n">line_alpha</span><span class="p">,</span>
            <span class="n">ell_alpha</span><span class="o">=</span><span class="n">ell_alpha</span><span class="p">,</span>
            <span class="n">vert</span><span class="o">=</span><span class="n">vert</span><span class="p">,</span>
            <span class="n">heatmask</span><span class="o">=</span><span class="n">heatmask</span><span class="p">,</span>
            <span class="n">line_lw</span><span class="o">=</span><span class="n">line_lw</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">xywh1</span><span class="p">,</span> <span class="n">xywh2</span></div>

<div class="viewcode-block" id="PairwiseMatch.ishow"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.ishow">[docs]</a>    <span class="k">def</span> <span class="nf">ishow</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m vtool.matching ishow --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # SCRIPT</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">            &gt;&gt;&gt; import wbia.guitool as gt</span>
<span class="sd">            &gt;&gt;&gt; gt.ensure_qapp()</span>
<span class="sd">            &gt;&gt;&gt; match = demodata_match(use_cache=False)</span>
<span class="sd">            &gt;&gt;&gt; self = match.ishow()</span>
<span class="sd">            &gt;&gt;&gt; self.disp_config[&#39;show_homog&#39;] = True</span>
<span class="sd">            &gt;&gt;&gt; self.update()</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">            &gt;&gt;&gt; gt.qtapp_loop(qwin=self, freq=10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">vtool.inspect_matches</span> <span class="kn">import</span> <span class="n">MatchInspector</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="n">MatchInspector</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">match</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PairwiseMatch.add_global_measures"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.add_global_measures">[docs]</a>    <span class="k">def</span> <span class="nf">add_global_measures</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">global_keys</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">global_keys</span><span class="p">:</span>
            <span class="n">match</span><span class="o">.</span><span class="n">global_measures</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="n">key</span><span class="p">])</span></div>

<div class="viewcode-block" id="PairwiseMatch.add_local_measures"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.add_local_measures">[docs]</a>    <span class="k">def</span> <span class="nf">add_local_measures</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="k">if</span> <span class="n">xy</span><span class="p">:</span>
            <span class="n">key_</span> <span class="o">=</span> <span class="s1">&#39;norm_xys&#39;</span>
            <span class="n">norm_xy1</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">[</span><span class="n">key_</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">norm_xy2</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="n">key_</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;norm_x1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_xy1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;norm_y1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_xy1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;norm_x2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_xy2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;norm_y2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_xy2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
            <span class="n">kpts1_m</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">kpts2_m</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;scale1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_scales</span><span class="p">(</span><span class="n">kpts1_m</span><span class="p">)</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;scale2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_scales</span><span class="p">(</span><span class="n">kpts2_m</span><span class="p">)</span></div>

<div class="viewcode-block" id="PairwiseMatch.matched_vecs2"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.matched_vecs2">[docs]</a>    <span class="k">def</span> <span class="nf">matched_vecs2</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_next_instance</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns either the same or a new instance of a match object with the</span>
<span class="sd">        same global attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inplace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inplace</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_inplace_default</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">match_</span> <span class="o">=</span> <span class="n">match</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">match_</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">)</span>
            <span class="n">match_</span><span class="o">.</span><span class="n">H_21</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">H_21</span>
            <span class="n">match_</span><span class="o">.</span><span class="n">H_12</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">H_12</span>
            <span class="n">match_</span><span class="o">.</span><span class="n">_inplace_default</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_inplace_default</span>
            <span class="n">match_</span><span class="o">.</span><span class="n">global_measures</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">global_measures</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">match_</span>

<div class="viewcode-block" id="PairwiseMatch.copy"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">match_</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_next_instance</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">match_</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">match_</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">local_measures</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">map_vals</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match_</span></div>

<div class="viewcode-block" id="PairwiseMatch.compress"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.compress">[docs]</a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] compressing </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">flags</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)))</span>
        <span class="n">match_</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_next_instance</span><span class="p">(</span><span class="n">inplace</span><span class="p">)</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">local_measures</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">map_vals</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">match_</span></div>

<div class="viewcode-block" id="PairwiseMatch.take"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.take">[docs]</a>    <span class="k">def</span> <span class="nf">take</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">indicies</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">match_</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_next_instance</span><span class="p">(</span><span class="n">inplace</span><span class="p">)</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indicies</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">local_measures</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">map_vals</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">indicies</span><span class="p">),</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">match_</span></div>

<div class="viewcode-block" id="PairwiseMatch.assign"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign feature correspondences between annots</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pyhesaff)</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; cfgdict = {&#39;symmetric&#39;: True}</span>
<span class="sd">            &gt;&gt;&gt; match = demodata_match({}, apply=False)</span>
<span class="sd">            &gt;&gt;&gt; m1 = match.copy().assign({&#39;symmetric&#39;: False})</span>
<span class="sd">            &gt;&gt;&gt; m2 = match.copy().assign({&#39;symmetric&#39;: True})</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:wbia)</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; grid = {</span>
<span class="sd">            &gt;&gt;&gt;     &#39;symmetric&#39;: [True, False],</span>
<span class="sd">            &gt;&gt;&gt; }</span>
<span class="sd">            &gt;&gt;&gt; for cfgdict in ut.all_dict_combinations(grid):</span>
<span class="sd">            &gt;&gt;&gt;     match = demodata_match(cfgdict, apply=False)</span>
<span class="sd">            &gt;&gt;&gt;     match.assign()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_take_params</span><span class="p">(</span>
            <span class="n">cfgdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Knorm&#39;</span><span class="p">,</span> <span class="s1">&#39;symmetric&#39;</span><span class="p">,</span> <span class="s1">&#39;checks&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="p">,</span> <span class="n">symmetric</span><span class="p">,</span> <span class="n">checks</span><span class="p">,</span> <span class="n">weight_key</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">annot1</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span>
        <span class="n">annot2</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span>

        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] assign&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] params = &#39;</span> <span class="o">+</span> <span class="n">ub</span><span class="o">.</span><span class="n">repr2</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>

        <span class="n">ensure_metadata_vsone</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">annot2</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>

        <span class="n">allow_shrink</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># TODO: parameterize?</span>

        <span class="c1"># Search for nearest neighbors</span>
        <span class="k">if</span> <span class="n">symmetric</span><span class="p">:</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="n">symmetric_correspondence</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">annot2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="p">,</span> <span class="n">checks</span><span class="p">,</span> <span class="n">allow_shrink</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tup</span> <span class="o">=</span> <span class="n">asymmetric_correspondence</span><span class="p">(</span>
                <span class="n">annot1</span><span class="p">,</span> <span class="n">annot2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="p">,</span> <span class="n">checks</span><span class="p">,</span> <span class="n">allow_shrink</span>
            <span class="p">)</span>
        <span class="n">fm</span><span class="p">,</span> <span class="n">match_dist</span><span class="p">,</span> <span class="n">norm_dist</span><span class="p">,</span> <span class="n">fx1_norm</span><span class="p">,</span> <span class="n">fx2_norm</span> <span class="o">=</span> <span class="n">tup</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">match_dist</span><span class="p">,</span> <span class="n">norm_dist</span><span class="p">)</span>
        <span class="c1"># convert so bigger is better</span>
        <span class="n">ratio_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span>

        <span class="c1"># remove local measure that can no longer apply</span>
        <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">dict_diff</span><span class="p">(</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sver_err_xy&#39;</span><span class="p">,</span> <span class="s1">&#39;sver_err_scale&#39;</span><span class="p">,</span> <span class="s1">&#39;sver_err_ori&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;match_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_dist</span>
        <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;norm_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_dist</span>
        <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span>
        <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;ratio_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio_score</span>

        <span class="k">if</span> <span class="n">weight_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">match</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">ratio_score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Weight the scores with specified attribute</span>
            <span class="c1"># (e.g. foregroundness weights)</span>
            <span class="n">weight1</span> <span class="o">=</span> <span class="n">annot1</span><span class="p">[</span><span class="n">weight_key</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">weight2</span> <span class="o">=</span> <span class="n">annot2</span><span class="p">[</span><span class="n">weight_key</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weight1</span> <span class="o">*</span> <span class="n">weight2</span><span class="p">)</span>
            <span class="n">weighted_ratio_score</span> <span class="o">=</span> <span class="n">ratio_score</span> <span class="o">*</span> <span class="n">weight</span>

            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="n">weight_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;weighted_ratio_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_ratio_score</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;weighted_norm_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_dist</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">match</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">weighted_ratio_score</span>

        <span class="n">match</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="n">fm</span>
        <span class="n">match</span><span class="o">.</span><span class="n">fm_norm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">fx1_norm</span><span class="p">,</span> <span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">fx2_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">match</span><span class="o">.</span><span class="n">fm_norm2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">match</span><span class="o">.</span><span class="n">fm_norm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fx2_norm</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">match</span></div>

<div class="viewcode-block" id="PairwiseMatch.ratio_test_flags"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.ratio_test_flags">[docs]</a>    <span class="k">def</span> <span class="nf">ratio_test_flags</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="p">(</span><span class="n">ratio_thresh</span><span class="p">,)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_take_params</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ratio_thresh&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] apply_ratio_test&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] ratio_thresh = </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratio_thresh</span><span class="p">))</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">ratio_thresh</span>
        <span class="k">return</span> <span class="n">flags</span></div>

<div class="viewcode-block" id="PairwiseMatch.sver_flags"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.sver_flags">[docs]</a>    <span class="k">def</span> <span class="nf">sver_flags</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{},</span> <span class="n">return_extra</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pyhesaff)</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; cfgdict = {&#39;symmetric&#39;: True, &#39;newsym&#39;: True}</span>
<span class="sd">            &gt;&gt;&gt; match = demodata_match(cfgdict, apply=False)</span>
<span class="sd">            &gt;&gt;&gt; cfgbase = {&#39;symmetric&#39;: True, &#39;ratio_thresh&#39;: .8}</span>
<span class="sd">            &gt;&gt;&gt; cfgdict = ut.dict_union(cfgbase, dict(thresh_bins=[.5, .6, .7, .8]))</span>
<span class="sd">            &gt;&gt;&gt; match = match.assign(cfgbase)</span>
<span class="sd">            &gt;&gt;&gt; match.apply_ratio_test(cfgdict, inplace=True)</span>
<span class="sd">            &gt;&gt;&gt; flags1 = match.sver_flags(cfgdict)</span>
<span class="sd">            &gt;&gt;&gt; flags2 = match.sver_flags(cfgbase)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">spatial_verification</span> <span class="k">as</span> <span class="n">sver</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="k">def</span> <span class="nf">_run_sver</span><span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">match_weights</span><span class="p">,</span> <span class="o">**</span><span class="n">sver_kw</span><span class="p">):</span>
            <span class="n">svtup</span> <span class="o">=</span> <span class="n">sver</span><span class="o">.</span><span class="n">spatially_verify_kpts</span><span class="p">(</span>
                <span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">match_weights</span><span class="o">=</span><span class="n">match_weights</span><span class="p">,</span> <span class="o">**</span><span class="n">sver_kw</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">svtup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
                <span class="n">inliers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">H_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">inliers</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">H_12</span><span class="p">)</span> <span class="o">=</span> <span class="n">svtup</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">svtup</span> <span class="o">=</span> <span class="p">(</span><span class="n">inliers</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">H_12</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">svtup</span>

        <span class="p">(</span>
            <span class="n">sver_xy_thresh</span><span class="p">,</span>
            <span class="n">sver_ori_thresh</span><span class="p">,</span>
            <span class="n">sver_scale_thresh</span><span class="p">,</span>
            <span class="n">refine_method</span><span class="p">,</span>
            <span class="n">thresh_bins</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_take_params</span><span class="p">(</span>
            <span class="n">cfgdict</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">&#39;sver_xy_thresh&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sver_ori_thresh&#39;</span><span class="p">,</span>
                <span class="s1">&#39;sver_scale_thresh&#39;</span><span class="p">,</span>
                <span class="s1">&#39;refine_method&#39;</span><span class="p">,</span>
                <span class="s1">&#39;thresh_bins&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>

        <span class="n">kpts1</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span>
        <span class="n">kpts2</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">]</span>
        <span class="n">dlen_sqrd2</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;dlen_sqrd&#39;</span><span class="p">]</span>

        <span class="n">sver_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">xy_thresh</span><span class="o">=</span><span class="n">sver_xy_thresh</span><span class="p">,</span>
            <span class="n">ori_thresh</span><span class="o">=</span><span class="n">sver_ori_thresh</span><span class="p">,</span>
            <span class="n">scale_thresh</span><span class="o">=</span><span class="n">sver_scale_thresh</span><span class="p">,</span>
            <span class="n">refine_method</span><span class="o">=</span><span class="n">refine_method</span><span class="p">,</span>
            <span class="n">dlen_sqrd2</span><span class="o">=</span><span class="n">dlen_sqrd2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">thresh_bins</span><span class="p">:</span>
            <span class="n">sver_tups</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">n_fm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">)</span>

            <span class="n">xy_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_fm</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">scale_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_fm</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">ori_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_fm</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">agg_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy_err</span><span class="p">,</span> <span class="n">scale_err</span><span class="p">,</span> <span class="n">ori_err</span><span class="p">)</span>

            <span class="n">agg_inlier_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_fm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>

            <span class="n">agg_H_12</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prev_best</span> <span class="o">=</span> <span class="mi">50</span>

            <span class="k">for</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="n">thresh_bins</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span>

                <span class="c1"># These are of len(match.fm)=1000</span>
                <span class="c1"># 100 of these are True</span>
                <span class="n">ratio_flags</span> <span class="o">=</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">thresh</span>
                <span class="n">ratio_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ratio_flags</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratio_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Filter matches at this level of the ratio test</span>
                <span class="n">fm</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">[</span><span class="n">ratio_flags</span><span class="p">]</span>
                <span class="n">match_weights</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">ratio_flags</span><span class="p">]</span>

                <span class="n">svtup</span> <span class="o">=</span> <span class="n">_run_sver</span><span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">match_weights</span><span class="p">,</span> <span class="o">**</span><span class="n">sver_kw</span><span class="p">)</span>
                <span class="p">(</span><span class="n">inliers</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">H_12</span><span class="p">)</span> <span class="o">=</span> <span class="n">svtup</span>
                <span class="n">n_inliers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inliers</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">agg_H_12</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n_inliers</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="ow">and</span> <span class="n">n_inliers</span> <span class="o">&gt;</span> <span class="n">prev_best</span><span class="p">):</span>
                    <span class="c1"># pick a homography from a lower ratio threshold if</span>
                    <span class="c1"># possible. TODO: check for H_12 = np.eye</span>
                    <span class="n">agg_H_12</span> <span class="o">=</span> <span class="n">H_12</span>
                    <span class="n">prev_best</span> <span class="o">=</span> <span class="n">n_inliers</span>

                <span class="c1"># these are of len(fm)=100</span>
                <span class="c1"># flags = vt.index_to_boolmask(inliers, len(fm))</span>
                <span class="c1"># print(errors[0][inliers].mean())</span>

                <span class="c1"># Find places that passed the ratio and were inliers</span>
                <span class="n">agg_inlier_flags</span><span class="p">[</span><span class="n">ratio_idxs</span><span class="p">[</span><span class="n">inliers</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">for</span> <span class="n">agg_err</span><span class="p">,</span> <span class="n">err</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">agg_errors</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
                        <span class="n">current_err</span> <span class="o">=</span> <span class="n">agg_err</span><span class="p">[</span><span class="n">ratio_idxs</span><span class="p">]</span>
                        <span class="n">agg_err</span><span class="p">[</span><span class="n">ratio_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">current_err</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

                <span class="n">sver_tups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">svtup</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_extra</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">agg_inlier_flags</span><span class="p">,</span> <span class="n">agg_errors</span><span class="p">,</span> <span class="n">agg_H_12</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">agg_inlier_flags</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># match_weights = np.ones(len(fm))</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fm</span>
            <span class="n">match_weights</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">fs</span>

            <span class="n">svtup</span> <span class="o">=</span> <span class="n">_run_sver</span><span class="p">(</span><span class="n">kpts1</span><span class="p">,</span> <span class="n">kpts2</span><span class="p">,</span> <span class="n">fm</span><span class="p">,</span> <span class="n">match_weights</span><span class="p">,</span> <span class="o">**</span><span class="n">sver_kw</span><span class="p">)</span>
            <span class="p">(</span><span class="n">inliers</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">H_12</span><span class="p">)</span> <span class="o">=</span> <span class="n">svtup</span>

            <span class="n">flags</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">index_to_boolmask</span><span class="p">(</span><span class="n">inliers</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fm</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">return_extra</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">flags</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">H_12</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">flags</span></div>

<div class="viewcode-block" id="PairwiseMatch.apply_all"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.apply_all">[docs]</a>    <span class="k">def</span> <span class="nf">apply_all</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] apply_all&#39;</span><span class="p">)</span>
        <span class="n">match</span><span class="o">.</span><span class="n">H_21</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">match</span><span class="o">.</span><span class="n">H_12</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([])</span>
        <span class="n">match</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">)</span>
        <span class="n">match</span><span class="o">.</span><span class="n">apply_ratio_test</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">sv_on</span><span class="p">,)</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">_take_params</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sv_on&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">sv_on</span><span class="p">:</span>
            <span class="n">match</span><span class="o">.</span><span class="n">apply_sver</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="PairwiseMatch.apply_ratio_test"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.apply_ratio_test">[docs]</a>    <span class="k">def</span> <span class="nf">apply_ratio_test</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">ratio_test_flags</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">)</span>
        <span class="n">match_</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match_</span></div>

<div class="viewcode-block" id="PairwiseMatch.apply_sver"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.apply_sver">[docs]</a>    <span class="k">def</span> <span class="nf">apply_sver</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; cfgdict = {&#39;symmetric&#39;: True, &#39;ratio_thresh&#39;: .8,</span>
<span class="sd">            &gt;&gt;&gt;            &#39;thresh_bins&#39;: [.5, .6, .7, .8]}</span>
<span class="sd">            &gt;&gt;&gt; match = demodata_match(cfgdict, apply=False)</span>
<span class="sd">            &gt;&gt;&gt; match = match.assign(cfgbase)</span>
<span class="sd">            &gt;&gt;&gt; match.apply_ratio_test(cfgdict, inplace=True)</span>
<span class="sd">            &gt;&gt;&gt; flags1 = match.apply_sver(cfgdict)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[match] apply_sver&#39;</span><span class="p">)</span>
        <span class="n">flags</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">H_12</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">sver_flags</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">,</span> <span class="n">return_extra</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">match_</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">)</span>
        <span class="n">errors_</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">]</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;sver_err_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;sver_err_scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="s1">&#39;sver_err_ori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">match_</span><span class="o">.</span><span class="n">H_12</span> <span class="o">=</span> <span class="n">H_12</span>
        <span class="k">return</span> <span class="n">match_</span></div>

    <span class="k">def</span> <span class="nf">_make_global_feature_vector</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">global_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Global annotation properties and deltas&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">feat</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([])</span>

        <span class="k">if</span> <span class="n">global_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># speed should need to be requested</span>
            <span class="n">global_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">global_measures</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">global_measures</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">global_measures</span><span class="p">,</span> <span class="n">global_keys</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">global_measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">v1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">v2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">isiterable</span><span class="p">(</span><span class="n">v1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)):</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(</span><span class="si">{}</span><span class="s1">_1[</span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(</span><span class="si">{}</span><span class="s1">_2[</span><span class="si">{}</span><span class="s1">])&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;gps&#39;</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">haversine</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(</span><span class="si">{}</span><span class="s1">_1)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v1</span>
                <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(</span><span class="si">{}</span><span class="s1">_2)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v2</span>
                <span class="c1"># if k == &#39;yaw&#39;:</span>
                <span class="c1">#     # delta = vt.ori_distance(v1, v2)</span>
                <span class="c1">#     delta = vt.cyclic_distance(v1, v2, modulo=vt.TAU)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;view&#39;</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">_rhomb_dist</span><span class="o">.</span><span class="n">VIEW_INT_DIST</span><span class="p">[(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)]</span>
                    <span class="c1"># delta = vt.cyclic_distance(v1, v2, modulo=8)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span>
            <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(delta_</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">delta</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;yaw&#39;</span><span class="p">,</span> <span class="s1">&#39;yaw is depricated&#39;</span>

        <span class="c1"># Impose ordering on these keys to add symmetry</span>
        <span class="n">keys_to_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qual&#39;</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_order</span><span class="p">:</span>
            <span class="n">k1</span> <span class="o">=</span> <span class="s1">&#39;global(</span><span class="si">{}</span><span class="s1">_1)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">k2</span> <span class="o">=</span> <span class="s1">&#39;global(</span><span class="si">{}</span><span class="s1">_2)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">and</span> <span class="n">k2</span> <span class="ow">in</span> <span class="n">feat</span><span class="p">:</span>
                <span class="n">minv</span><span class="p">,</span> <span class="n">maxv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">feat</span><span class="p">[</span><span class="n">k1</span><span class="p">],</span> <span class="n">feat</span><span class="p">[</span><span class="n">k2</span><span class="p">]])</span>
                <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(min_</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">minv</span>
                <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(max_</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">maxv</span>

        <span class="k">if</span> <span class="s1">&#39;global(delta_gps)&#39;</span> <span class="ow">in</span> <span class="n">feat</span> <span class="ow">and</span> <span class="s1">&#39;global(delta_time)&#39;</span> <span class="ow">in</span> <span class="n">feat</span><span class="p">:</span>
            <span class="n">hour_delta</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(delta_time)&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">360</span>
            <span class="n">km_delta</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(delta_gps)&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">hour_delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">km_delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(speed)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(speed)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;global(speed)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">km_delta</span> <span class="o">/</span> <span class="n">hour_delta</span>
        <span class="k">return</span> <span class="n">feat</span>

    <span class="k">def</span> <span class="nf">_make_local_summary_feature_vector</span><span class="p">(</span>
        <span class="n">match</span><span class="p">,</span> <span class="n">local_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summary_ops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summary statistics of local features</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m vtool.matching _make_local_summary_feature_vector</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pyhesaff)</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">            &gt;&gt;&gt; cfgdict = {}</span>
<span class="sd">            &gt;&gt;&gt; match = demodata_match(cfgdict, recompute=0)</span>
<span class="sd">            &gt;&gt;&gt; match.apply_all(cfgdict)</span>
<span class="sd">            &gt;&gt;&gt; summary_ops = {&#39;len&#39;, &#39;sum&#39;}</span>
<span class="sd">            &gt;&gt;&gt; bin_key = &#39;ratio&#39;</span>
<span class="sd">            &gt;&gt;&gt; bins = 2</span>
<span class="sd">            &gt;&gt;&gt; #bins = [.625, .725, .9]</span>
<span class="sd">            &gt;&gt;&gt; bins = [.625, .9]</span>
<span class="sd">            &gt;&gt;&gt; local_keys = [&#39;ratio&#39;, &#39;norm_dist&#39;, &#39;ratio_score&#39;]</span>
<span class="sd">            &gt;&gt;&gt; bin_key = None</span>
<span class="sd">            &gt;&gt;&gt; local_keys = None</span>
<span class="sd">            &gt;&gt;&gt; summary_ops = &#39;all&#39;</span>
<span class="sd">            &gt;&gt;&gt; feat = match._make_local_summary_feature_vector(</span>
<span class="sd">            &gt;&gt;&gt;     local_keys=local_keys,</span>
<span class="sd">            &gt;&gt;&gt;     bin_key=bin_key, summary_ops=summary_ops, bins=bins)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;feat = %s&#39; % (ub.repr2(feat, nl=2),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">summary_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">summary_ops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;len&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">summary_ops</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">summary_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">SUM_OPS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="s1">&#39;len&#39;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">local_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_measures</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_measures</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">,</span> <span class="n">local_keys</span><span class="p">)</span>

        <span class="n">feat</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">bin_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must choose bins&#39;</span><span class="p">)</span>
                <span class="c1"># bins = [.625, .725, .9]</span>
            <span class="c1"># binned ratio feature vectors</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">bin_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="n">bin_key</span><span class="p">])</span>

            <span class="n">dimkey_fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{opname}</span><span class="s1">(</span><span class="si">{measure}</span><span class="s1">[</span><span class="si">{bin_key}</span><span class="s1">&lt;</span><span class="si">{binval}</span><span class="s1">])&#39;</span>
            <span class="k">for</span> <span class="n">binid</span><span class="p">,</span> <span class="n">binval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">fxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bin_ids</span> <span class="o">&lt;=</span> <span class="n">binid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;len&#39;</span> <span class="ow">in</span> <span class="n">summary_ops</span><span class="p">:</span>
                    <span class="n">dimkey</span> <span class="o">=</span> <span class="n">dimkey_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">opname</span><span class="o">=</span><span class="s1">&#39;len&#39;</span><span class="p">,</span>
                        <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;matches&#39;</span><span class="p">,</span>
                        <span class="n">bin_key</span><span class="o">=</span><span class="n">bin_key</span><span class="p">,</span>
                        <span class="n">binval</span><span class="o">=</span><span class="n">binval</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">feat</span><span class="p">[</span><span class="n">dimkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fxs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">opname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">summary_ops</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;len&#39;</span><span class="p">}):</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">SUM_OPS</span><span class="p">[</span><span class="n">opname</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">local_measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">dimkey</span> <span class="o">=</span> <span class="n">dimkey_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">opname</span><span class="o">=</span><span class="n">opname</span><span class="p">,</span>
                            <span class="n">measure</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                            <span class="n">bin_key</span><span class="o">=</span><span class="n">bin_key</span><span class="p">,</span>
                            <span class="n">binval</span><span class="o">=</span><span class="n">binval</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">feat</span><span class="p">[</span><span class="n">dimkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">vs</span><span class="p">[</span><span class="n">fxs</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">dimkey_fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{opname}</span><span class="s1">(</span><span class="si">{measure}</span><span class="s1">)&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;len&#39;</span> <span class="ow">in</span> <span class="n">summary_ops</span><span class="p">:</span>
                    <span class="n">dimkey</span> <span class="o">=</span> <span class="n">dimkey_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opname</span><span class="o">=</span><span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="s1">&#39;matches&#39;</span><span class="p">)</span>
                    <span class="n">feat</span><span class="p">[</span><span class="n">dimkey</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">opname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">summary_ops</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;len&#39;</span><span class="p">}):</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">SUM_OPS</span><span class="p">[</span><span class="n">opname</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">local_measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">dimkey</span> <span class="o">=</span> <span class="n">dimkey_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opname</span><span class="o">=</span><span class="n">opname</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">feat</span><span class="p">[</span><span class="n">dimkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># OLD</span>
                <span class="k">if</span> <span class="s1">&#39;len&#39;</span> <span class="ow">in</span> <span class="n">summary_ops</span><span class="p">:</span>
                    <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;len(matches)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;sum&#39;</span> <span class="ow">in</span> <span class="n">summary_ops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">local_measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;sum(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,)]</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;mean&#39;</span> <span class="ow">in</span> <span class="n">summary_ops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">local_measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;mean(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;std&#39;</span> <span class="ow">in</span> <span class="n">summary_ops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">local_measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;std(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;med&#39;</span> <span class="ow">in</span> <span class="n">summary_ops</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">local_measures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">feat</span><span class="p">[</span><span class="s1">&#39;med(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feat</span>

    <span class="k">def</span> <span class="nf">_make_local_top_feature_vector</span><span class="p">(</span>
        <span class="n">match</span><span class="p">,</span> <span class="n">local_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sorters</span><span class="o">=</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selected subsets of top features&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">local_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_measures</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_measures</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">dict_subset</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">,</span> <span class="n">local_keys</span><span class="p">)</span>

        <span class="c1"># Convert indices to an explicit list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="c1"># assert indices.stop is not None, &#39;indices must have maximum value&#39;</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">fm</span><span class="p">))))</span>
            <span class="c1"># indices = list(range(*indices.indices(indices.stop)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="c1"># TODO: some sorters might want descending orders</span>
        <span class="n">sorters</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">ensure_iterable</span><span class="p">(</span><span class="n">sorters</span><span class="p">)</span>
        <span class="n">chosen_xs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">match</span><span class="o">.</span><span class="n">local_measures</span><span class="p">[</span><span class="n">sorter</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span> <span class="k">for</span> <span class="n">sorter</span> <span class="ow">in</span> <span class="n">sorters</span>
        <span class="p">]</span>
        <span class="n">loc_fmt</span> <span class="o">=</span> <span class="s1">&#39;loc[</span><span class="si">{sorter}</span><span class="s1">,</span><span class="si">{rank}</span><span class="s1">](</span><span class="si">{measure}</span><span class="s1">)&#39;</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">loc_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sorter</span><span class="o">=</span><span class="n">sorter</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sorter</span><span class="p">,</span> <span class="n">topxs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sorters</span><span class="p">,</span> <span class="n">chosen_xs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vs</span> <span class="ow">in</span> <span class="n">local_measures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">vs</span><span class="p">[</span><span class="n">topxs</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">feat</span>

<div class="viewcode-block" id="PairwiseMatch.make_feature_vector"><a class="viewcode-back" href="../../vtool.html#vtool.matching.PairwiseMatch.make_feature_vector">[docs]</a>    <span class="k">def</span> <span class="nf">make_feature_vector</span><span class="p">(</span>
        <span class="n">match</span><span class="p">,</span>
        <span class="n">local_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">global_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">summary_ops</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sorters</span><span class="o">=</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span>
        <span class="n">indices</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">bin_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the pairwise feature vector that represents a match</span>

<span class="sd">        Args:</span>
<span class="sd">            local_keys (None): (default = None)</span>
<span class="sd">            global_keys (None): (default = None)</span>
<span class="sd">            summary_ops (None): (default = None)</span>
<span class="sd">            sorters (str): (default = &#39;ratio&#39;)</span>
<span class="sd">            indices (int): (default = 3)</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: feat</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m vtool.matching make_feature_vector</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">            &gt;&gt;&gt; match = demodata_match({})</span>
<span class="sd">            &gt;&gt;&gt; feat = match.make_feature_vector(indices=[0, 1])</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;feat = %s&#39; % (ub.repr2(feat, nl=2),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">feat</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">odict</span><span class="p">([])</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">feat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">_make_global_feature_vector</span><span class="p">(</span><span class="n">global_keys</span><span class="p">))</span>
            <span class="n">feat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">match</span><span class="o">.</span><span class="n">_make_local_summary_feature_vector</span><span class="p">(</span>
                    <span class="n">local_keys</span><span class="p">,</span> <span class="n">summary_ops</span><span class="p">,</span> <span class="n">bin_key</span><span class="o">=</span><span class="n">bin_key</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">feat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">match</span><span class="o">.</span><span class="n">_make_local_top_feature_vector</span><span class="p">(</span>
                    <span class="n">local_keys</span><span class="p">,</span> <span class="n">sorters</span><span class="o">=</span><span class="n">sorters</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">feat</span></div></div>


<div class="viewcode-block" id="invsum"><a class="viewcode-back" href="../../vtool.html#vtool.matching.invsum">[docs]</a><span class="k">def</span> <span class="nf">invsum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="csum"><a class="viewcode-back" href="../../vtool.html#vtool.matching.csum">[docs]</a><span class="k">def</span> <span class="nf">csum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<span class="c1"># Different summary options available for pairwise feature vecs</span>
<span class="n">SUM_OPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># &#39;len&#39;    : len,</span>
    <span class="s1">&#39;invsum&#39;</span><span class="p">:</span> <span class="n">invsum</span><span class="p">,</span>
    <span class="c1"># &#39;csum&#39;   : csum,</span>
    <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span>
    <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span>
    <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">,</span>
    <span class="s1">&#39;med&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="AnnotPairFeatInfo"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo">[docs]</a><span class="nd">@ut</span><span class="o">.</span><span class="n">reloadable_class</span>
<span class="k">class</span> <span class="nc">AnnotPairFeatInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information class about feature dimensions of PairwiseMatch.</span>

<span class="sd">    Notes:</span>
<span class="sd">        Can be used to compute marginal importances over groups of features</span>
<span class="sd">        used in the pairwise one-vs-one scoring algorithm</span>

<span class="sd">        Can be used to construct an appropriate cfgdict for a new</span>
<span class="sd">        PairwiseMatch.</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.matching AnnotPairFeatInfo</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pyhesaff)</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">        &gt;&gt;&gt; match = demodata_match({})</span>
<span class="sd">        &gt;&gt;&gt; match.add_global_measures([&#39;time&#39;, &#39;gps&#39;])</span>
<span class="sd">        &gt;&gt;&gt; index = pd.MultiIndex.from_tuples([(1, 2)], names=(&#39;aid1&#39;, &#39;aid2&#39;))</span>
<span class="sd">        &gt;&gt;&gt; # Feat info without bins</span>
<span class="sd">        &gt;&gt;&gt; feat = match.make_feature_vector()</span>
<span class="sd">        &gt;&gt;&gt; X = pd.DataFrame(feat, index=index)</span>
<span class="sd">        &gt;&gt;&gt; print(X.keys())</span>
<span class="sd">        &gt;&gt;&gt; featinfo = AnnotPairFeatInfo(X)</span>
<span class="sd">        &gt;&gt;&gt; pairfeat_cfg, global_keys = featinfo.make_pairfeat_cfg()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;pairfeat_cfg = %r&#39; % (pairfeat_cfg,))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;global_keys = %r&#39; % (global_keys,))</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;delta&#39; not in global_keys</span>
<span class="sd">        &gt;&gt;&gt; assert &#39;max&#39; not in global_keys</span>
<span class="sd">        &gt;&gt;&gt; ut.cprint(featinfo.get_infostr(), &#39;blue&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # Feat info with bins</span>
<span class="sd">        &gt;&gt;&gt; feat = match.make_feature_vector(indices=0, bins=[.7, .8], bin_key=&#39;ratio&#39;)</span>
<span class="sd">        &gt;&gt;&gt; X = pd.DataFrame(feat, index=index)</span>
<span class="sd">        &gt;&gt;&gt; print(X.keys())</span>
<span class="sd">        &gt;&gt;&gt; featinfo = AnnotPairFeatInfo(X)</span>
<span class="sd">        &gt;&gt;&gt; pairfeat_cfg, global_keys = featinfo.make_pairfeat_cfg()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;pairfeat_cfg = %s&#39; % (ut.repr4(pairfeat_cfg),))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;global_keys = %r&#39; % (global_keys,))</span>
<span class="sd">        &gt;&gt;&gt; ut.cprint(featinfo.get_infostr(), &#39;blue&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">importances</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">featinfo</span><span class="o">.</span><span class="n">importances</span> <span class="o">=</span> <span class="n">importances</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">):</span>
                <span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">importances</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">importances</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">importances</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="s1">&#39;must be a dict&#39;</span>
        <span class="n">featinfo</span><span class="o">.</span><span class="n">_summary_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">SUM_OPS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="AnnotPairFeatInfo.make_pairfeat_cfg"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.make_pairfeat_cfg">[docs]</a>    <span class="k">def</span> <span class="nf">make_pairfeat_cfg</span><span class="p">(</span><span class="n">featinfo</span><span class="p">):</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;measure_type&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">)]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">select_columns</span><span class="p">(</span><span class="n">criteria</span><span class="p">))))</span>
        <span class="p">)</span>
        <span class="n">sorters</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">local_sorter</span><span class="p">,</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">select_columns</span><span class="p">(</span><span class="n">criteria</span><span class="p">)))</span>
        <span class="p">)</span>

        <span class="n">criteria</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;measure_type&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;global&#39;</span><span class="p">)]</span>
        <span class="n">global_measures</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">global_measure</span><span class="p">,</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">select_columns</span><span class="p">(</span><span class="n">criteria</span><span class="p">)))</span>
        <span class="p">)</span>

        <span class="n">global_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">global_measures</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">}</span>
            <span class="n">global_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">offset</span><span class="p">])</span>
        <span class="n">global_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">global_keys</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;speed&#39;</span> <span class="ow">in</span> <span class="n">global_keys</span><span class="p">:</span>
            <span class="n">global_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;speed&#39;</span><span class="p">)</span>  <span class="c1"># hack</span>

        <span class="n">summary_cols</span> <span class="o">=</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">select_columns</span><span class="p">([(</span><span class="s1">&#39;measure_type&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">)])</span>
        <span class="n">summary_ops</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_op</span><span class="p">,</span> <span class="n">summary_cols</span><span class="p">)))</span>
        <span class="n">summary_measures</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_measure</span><span class="p">,</span> <span class="n">summary_cols</span><span class="p">)))</span>
        <span class="n">summary_binvals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_binval</span><span class="p">,</span> <span class="n">summary_cols</span><span class="p">)))</span>
        <span class="n">summary_binvals</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">summary_binvals</span><span class="p">)</span>
        <span class="n">summary_binkeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_binkey</span><span class="p">,</span> <span class="n">summary_cols</span><span class="p">)))</span>
        <span class="n">summary_binkeys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">filter_Nones</span><span class="p">(</span><span class="n">summary_binkeys</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;matches&#39;</span> <span class="ow">in</span> <span class="n">summary_measures</span><span class="p">:</span>
            <span class="n">summary_measures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;matches&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary_binkeys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bin_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">summary_binkeys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">bin_key</span> <span class="o">=</span> <span class="n">summary_binkeys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pairfeat_cfg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;summary_ops&#39;</span><span class="p">:</span> <span class="n">summary_ops</span><span class="p">,</span>
            <span class="s1">&#39;local_keys&#39;</span><span class="p">:</span> <span class="n">summary_measures</span><span class="p">,</span>
            <span class="s1">&#39;sorters&#39;</span><span class="p">:</span> <span class="n">sorters</span><span class="p">,</span>
            <span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
            <span class="s1">&#39;bins&#39;</span><span class="p">:</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">summary_binvals</span><span class="p">),</span>
            <span class="s1">&#39;bin_key&#39;</span><span class="p">:</span> <span class="n">bin_key</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">pairfeat_cfg</span><span class="p">,</span> <span class="n">global_keys</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.select_columns"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.select_columns">[docs]</a>    <span class="k">def</span> <span class="nf">select_columns</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">criteria</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s1">&#39;and&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            criteria (list): list of tokens denoting selection constraints</span>
<span class="sd">               can be one of:</span>
<span class="sd">               measure_type global_measure, local_sorter, local_rank,</span>
<span class="sd">               local_measure, summary_measure, summary_op, summary_bin,</span>
<span class="sd">               summary_binval, summary_binkey,</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; featinfo.select_columns([</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;measure_type&#39;, &#39;==&#39;, &#39;local&#39;),</span>
<span class="sd">            &gt;&gt;&gt;     (&#39;local_sorter&#39;, &#39;in&#39;, [&#39;weighted_ratio_score&#39;, &#39;lnbnn_norm_dist&#39;]),</span>
<span class="sd">            &gt;&gt;&gt; ], op=&#39;and&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">intersection_update</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">update</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">update</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cols</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.find"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">hack</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        groupid options:</span>
<span class="sd">           measure_type global_measure, local_sorter, local_rank,</span>
<span class="sd">           local_measure, summary_measure, summary_op, summary_bin,</span>
<span class="sd">           summary_binval, summary_binkey,</span>

<span class="sd">        Ignore:</span>
<span class="sd">            group_id = &#39;summary_op&#39;</span>
<span class="sd">            op = &#39;==&#39;</span>
<span class="sd">            value = &#39;len&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">six</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">):</span>
            <span class="n">opdict</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_comparison_operators</span><span class="p">()</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">opdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="n">grouper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">value1</span> <span class="o">=</span> <span class="n">grouper</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># TODO: turn hack off and ensure that doesn&#39;t break anything</span>
                <span class="k">if</span> <span class="n">hack</span><span class="p">:</span>
                    <span class="c1"># Only filter out/in comparable things</span>
                    <span class="c1"># why? Is this just a hack? I forgot why I wrote this.</span>
                    <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                            <span class="n">value1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                            <span class="n">value1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                                <span class="n">value1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">op</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                        <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">return</span> <span class="n">found</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.group_importance"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.group_importance">[docs]</a>    <span class="k">def</span> <span class="nf">group_importance</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">importances</span><span class="p">,</span> <span class="n">keys</span><span class="p">))</span>
        <span class="n">ave_w</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">/</span> <span class="n">num</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">ave_w</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">num</span>
        <span class="c1"># return tup</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">tup</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ave_w&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.print_margins"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.print_margins">[docs]</a>    <span class="k">def</span> <span class="nf">print_margins</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">ignore_trivial</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">select_columns</span><span class="p">(</span><span class="n">criteria</span><span class="o">=</span><span class="n">group_id</span><span class="p">)</span>
            <span class="n">_keys</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">group_importance</span><span class="p">,</span> <span class="n">_keys</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">_weights</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">pass</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grouper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
            <span class="n">_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">grouper</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
            <span class="n">_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">group_importance</span><span class="p">,</span> <span class="n">_keys</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">grouper</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">pluralize</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_weights</span> <span class="o">=</span> <span class="n">_weights</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">_weights</span><span class="p">[</span><span class="s1">&#39;ave_w&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_trivial</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">_weights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ut</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Marginal importance of &#39;</span> <span class="o">+</span> <span class="n">nice</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_weights</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.group_counts"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.group_counts">[docs]</a>    <span class="k">def</span> <span class="nf">group_counts</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">item</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span><span class="p">,)</span>
        <span class="c1"># return tup</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">tup</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.print_counts"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.print_counts">[docs]</a>    <span class="k">def</span> <span class="nf">print_counts</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">grouper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
        <span class="n">_keys</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">group_items</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">grouper</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
        <span class="n">_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">group_counts</span><span class="p">,</span> <span class="n">_keys</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">_weights</span> <span class="o">=</span> <span class="n">_weights</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">_weights</span><span class="p">[</span><span class="s1">&#39;num&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">get_funcname</span><span class="p">(</span><span class="n">grouper</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">nice</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">pluralize</span><span class="p">(</span><span class="n">nice</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Counts of &#39;</span> <span class="o">+</span> <span class="n">nice</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">_weights</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.feature"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.feature">[docs]</a>    <span class="k">def</span> <span class="nf">feature</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.measure"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.measure">[docs]</a>    <span class="k">def</span> <span class="nf">measure</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{type}</span><span class="s1">(</span><span class="si">{measure}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{type}</span><span class="s1">(</span><span class="si">{measure}</span><span class="s1">[</span><span class="si">{bin}</span><span class="s1">])&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.global_measure"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.global_measure">[docs]</a>    <span class="k">def</span> <span class="nf">global_measure</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;global(</span><span class="si">{measure}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span></div>

    <span class="n">loc_fmt</span> <span class="o">=</span> <span class="s1">&#39;loc[</span><span class="si">{sorter}</span><span class="s1">,</span><span class="si">{rank}</span><span class="s1">](</span><span class="si">{measure}</span><span class="s1">)&#39;</span>

<div class="viewcode-block" id="AnnotPairFeatInfo.local_measure"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.local_measure">[docs]</a>    <span class="k">def</span> <span class="nf">local_measure</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">loc_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.local_sorter"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.local_sorter">[docs]</a>    <span class="k">def</span> <span class="nf">local_sorter</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">loc_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;sorter&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.local_rank"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.local_rank">[docs]</a>    <span class="k">def</span> <span class="nf">local_rank</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">loc_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span></div>

    <span class="n">sum_fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{op}</span><span class="s1">(</span><span class="si">{measure}</span><span class="s1">)&#39;</span>
    <span class="n">binsum_fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{op}</span><span class="s1">(</span><span class="si">{measure}</span><span class="s1">[</span><span class="si">{bin_key}</span><span class="s1">&lt;</span><span class="si">{binval}</span><span class="s1">])&#39;</span>

<div class="viewcode-block" id="AnnotPairFeatInfo.summary_measure"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.summary_measure">[docs]</a>    <span class="k">def</span> <span class="nf">summary_measure</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">binsum_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">sum_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">_summary_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;measure&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.summary_op"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.summary_op">[docs]</a>    <span class="k">def</span> <span class="nf">summary_op</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">binsum_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">sum_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">_summary_keys</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;op&#39;</span><span class="p">]</span></div>

    <span class="c1"># def summary_bin(featinfo, key):</span>
    <span class="c1">#     parsed = parse.parse(featinfo.binsum_fmt, key)</span>
    <span class="c1">#     if parsed is not None:</span>
    <span class="c1">#         return parsed[&#39;bin_key&#39;] + &#39;&lt;&#39; + parsed[&#39;binval&#39;]</span>

<div class="viewcode-block" id="AnnotPairFeatInfo.summary_binkey"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.summary_binkey">[docs]</a>    <span class="k">def</span> <span class="nf">summary_binkey</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">binsum_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;bin_key&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.summary_binval"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.summary_binval">[docs]</a>    <span class="k">def</span> <span class="nf">summary_binval</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">binsum_fmt</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parsed</span><span class="p">[</span><span class="s1">&#39;binval&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.dimkey_grammar"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.dimkey_grammar">[docs]</a>    <span class="k">def</span> <span class="nf">dimkey_grammar</span><span class="p">(</span><span class="n">featinfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CommandLine:</span>
<span class="sd">            python -m vtool.matching AnnotPairFeatInfo.dimkey_grammar</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pyhesaff)</span>
<span class="sd">            &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">            &gt;&gt;&gt; match = demodata_match({})</span>
<span class="sd">            &gt;&gt;&gt; match.add_global_measures([&#39;view&#39;, &#39;qual&#39;, &#39;gps&#39;, &#39;time&#39;])</span>
<span class="sd">            &gt;&gt;&gt; index = pd.MultiIndex.from_tuples([(1, 2)], names=(&#39;aid1&#39;, &#39;aid2&#39;))</span>
<span class="sd">            &gt;&gt;&gt; # Feat info without bins</span>
<span class="sd">            &gt;&gt;&gt; feat = match.make_feature_vector()</span>
<span class="sd">            &gt;&gt;&gt; X = pd.DataFrame(feat, index=index)</span>
<span class="sd">            &gt;&gt;&gt; featinfo = AnnotPairFeatInfo(X)</span>
<span class="sd">            &gt;&gt;&gt; feat_grammar = featinfo.dimkey_grammar()</span>
<span class="sd">            &gt;&gt;&gt; for key in X.keys():</span>
<span class="sd">            &gt;&gt;&gt;     print(key)</span>
<span class="sd">            &gt;&gt;&gt;     print(feat_grammar.parseString(key))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://stackoverflow.com/questions/18706631/pyparsing-get-token-location-in-results-name</span>
        <span class="c1"># Here is a start of a grammer if we need to get serious</span>
        <span class="kn">import</span> <span class="nn">pyparsing</span> <span class="k">as</span> <span class="nn">pp</span>

        <span class="c1"># locator = pp.Empty().setParseAction(lambda s, l, t: l)</span>
        <span class="c1"># with feature dimension name encoding</span>
        <span class="c1"># _summary_keys = [&#39;sum&#39;, &#39;mean&#39;, &#39;med&#39;, &#39;std&#39;, &#39;len&#39;]</span>
        <span class="n">_summary_keys</span> <span class="o">=</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">_summary_keys</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Suppress</span>

        <span class="k">class</span> <span class="nc">Nestings</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;allows for a bit of syntactic sugar&quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">pp</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">pp</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="n">pp</span><span class="o">.</span><span class="n">Suppress</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>

        <span class="n">brak</span> <span class="o">=</span> <span class="n">paren</span> <span class="o">=</span> <span class="n">Nestings</span><span class="p">()</span>
        <span class="n">unary_id</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s1">&#39;[12]&#39;</span><span class="p">)</span>
        <span class="n">unary_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">unary_id</span><span class="p">)(</span><span class="s1">&#39;unary_id&#39;</span><span class="p">)</span>
        <span class="c1"># takes care of non-greedy matching of underscores</span>
        <span class="c1"># http://stackoverflow.com/questions/1905278/keyword-matching-in-</span>
        <span class="n">unary_measure</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Combine</span><span class="p">(</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphanums</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="o">.</span><span class="n">ZeroOrMore</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="o">~</span><span class="n">unary_id</span> <span class="o">+</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphanums</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">unary_sub</span> <span class="o">=</span> <span class="n">brak</span><span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">nums</span><span class="p">)]</span>
        <span class="n">global_unary</span> <span class="o">=</span> <span class="n">unary_measure</span> <span class="o">+</span> <span class="n">S</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">unary_id</span> <span class="o">+</span> <span class="n">pp</span><span class="o">.</span><span class="n">ZeroOrMore</span><span class="p">(</span><span class="n">unary_sub</span><span class="p">)</span>
        <span class="n">global_unary</span> <span class="o">=</span> <span class="p">(</span><span class="n">global_unary</span><span class="p">)(</span><span class="s1">&#39;global_unary&#39;</span><span class="p">)</span>

        <span class="n">global_relation</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">global_relation</span> <span class="o">=</span> <span class="p">(</span><span class="n">global_relation</span><span class="p">)(</span><span class="s1">&#39;global_relation&#39;</span><span class="p">)</span>

        <span class="n">global_measure</span> <span class="o">=</span> <span class="n">global_unary</span> <span class="o">|</span> <span class="n">global_relation</span>
        <span class="n">global_feature</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;global&#39;</span> <span class="o">+</span> <span class="n">paren</span><span class="p">(</span><span class="n">global_measure</span><span class="p">))(</span><span class="s1">&#39;global_feature&#39;</span><span class="p">)</span>
        <span class="c1"># Local</span>
        <span class="n">local_measure</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">local_sorter</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">local_rank</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">nums</span><span class="p">)</span>
        <span class="n">local_rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_rank</span><span class="p">)(</span><span class="s1">&#39;local_rank&#39;</span><span class="p">)</span>
        <span class="n">local_sorter</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_sorter</span><span class="p">)(</span><span class="s1">&#39;local_sorter&#39;</span><span class="p">)</span>
        <span class="n">local_measure</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_measure</span><span class="p">)(</span><span class="s1">&#39;local_measure&#39;</span><span class="p">)</span>
        <span class="n">local_feature</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;loc&#39;</span> <span class="o">+</span> <span class="n">brak</span><span class="p">[</span><span class="n">local_sorter</span> <span class="o">+</span> <span class="n">S</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">local_rank</span><span class="p">]</span> <span class="o">+</span> <span class="n">paren</span><span class="p">(</span><span class="n">local_measure</span><span class="p">)</span>
        <span class="p">)(</span><span class="s1">&#39;local_feature&#39;</span><span class="p">)</span>
        <span class="c1"># Summary</span>
        <span class="n">summary_measure</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)(</span><span class="s1">&#39;summary_measure&#39;</span><span class="p">)</span>
        <span class="n">summary_binkey</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphas</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">)(</span><span class="s1">&#39;summary_binkey&#39;</span><span class="p">)</span>
        <span class="n">summary_binval</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">nums</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)(</span><span class="s1">&#39;summary_binval&#39;</span><span class="p">)</span>

        <span class="n">summary_bin</span> <span class="o">=</span> <span class="n">brak</span><span class="p">[</span><span class="n">summary_binkey</span> <span class="o">+</span> <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="n">summary_binval</span><span class="p">](</span><span class="s1">&#39;summary_bin&#39;</span><span class="p">)</span>
        <span class="n">summary_op</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">_summary_keys</span><span class="p">)(</span><span class="s1">&#39;summary_op&#39;</span><span class="p">)</span>

        <span class="n">summary_feature</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">summary_op</span> <span class="o">+</span> <span class="n">paren</span><span class="p">(</span><span class="n">summary_measure</span> <span class="o">+</span> <span class="n">pp</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="n">summary_bin</span><span class="p">))</span>
        <span class="p">)(</span><span class="s1">&#39;summary_feature&#39;</span><span class="p">)</span>
        <span class="n">feat_grammar</span> <span class="o">=</span> <span class="n">local_feature</span> <span class="o">|</span> <span class="n">global_feature</span> <span class="o">|</span> <span class="n">summary_feature</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">global_feature</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="s1">&#39;global(qual_1)&#39;</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">feat_grammar</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="s1">&#39;global(min_qual)&#39;</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">feat_grammar</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="s1">&#39;loc[ratio,1](norm_dist)&#39;</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">feat_grammar</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="s1">&#39;mean(dist[ratio&lt;1])&#39;</span><span class="p">)</span>
            <span class="n">z</span>
        <span class="k">return</span> <span class="n">feat_grammar</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.measure_type"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.measure_type">[docs]</a>    <span class="k">def</span> <span class="nf">measure_type</span><span class="p">(</span><span class="n">featinfo</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;global&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;global&#39;</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;loc&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;local&#39;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">_summary_keys</span><span class="p">):</span>
            <span class="c1"># if &#39;[b&#39; in key:  # ]</span>
            <span class="c1">#     return &#39;binned_summary&#39;</span>
            <span class="c1"># else:</span>
            <span class="k">return</span> <span class="s1">&#39;summary&#39;</span></div>

<div class="viewcode-block" id="AnnotPairFeatInfo.get_infostr"><a class="viewcode-back" href="../../vtool.html#vtool.matching.AnnotPairFeatInfo.get_infostr">[docs]</a>    <span class="k">def</span> <span class="nf">get_infostr</span><span class="p">(</span><span class="n">featinfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarizes the types (global, local, summary) of features in X based on</span>
<span class="sd">        standardized dimension names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grouped_keys</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">ddict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="n">featinfo</span><span class="o">.</span><span class="n">measure_type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">grouped_keys</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">info_items</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">odict</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="s1">&#39;global_measures&#39;</span><span class="p">,</span>
                    <span class="n">ut</span><span class="o">.</span><span class="n">lmap</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">global_measure</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">]),</span>
                <span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;local_sorters&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">local_sorter</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]))),</span>
                <span class="p">(</span><span class="s1">&#39;local_ranks&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]))),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;local_measures&#39;</span><span class="p">,</span>
                    <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">local_measure</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">])),</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;summary_measures&#39;</span><span class="p">,</span>
                    <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_measure</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">])),</span>
                <span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;summary_ops&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_op</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]))),</span>
                <span class="c1"># (&#39;summary_bins&#39;, set(map(featinfo.summary_bin,</span>
                <span class="c1">#                          grouped_keys[&#39;summary&#39;]))),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;summary_binvals&#39;</span><span class="p">,</span>
                    <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_binval</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">])),</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="s1">&#39;summary_binkeys&#39;</span><span class="p">,</span>
                    <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">summary_binkey</span><span class="p">,</span> <span class="n">grouped_keys</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">])),</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="kn">import</span> <span class="nn">textwrap</span>

        <span class="k">def</span> <span class="nf">_wrap</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
            <span class="n">unwrapped</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">list_</span><span class="p">))</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="n">lines_</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">))</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines_</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">lines</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Feature Dimensions: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">featinfo</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info_items</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">list_</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">list_</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">list_</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_measures&#39;</span><span class="p">):</span>
                    <span class="n">groupid</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_measures&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouped_keys</span><span class="p">[</span><span class="n">groupid</span><span class="p">])</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39; (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;summary_measures&#39;</span><span class="p">:</span>
                    <span class="n">other</span> <span class="o">=</span> <span class="n">info_items</span><span class="p">[</span><span class="s1">&#39;local_measures&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">list_</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">remain</span> <span class="o">=</span> <span class="n">list_</span> <span class="o">-</span> <span class="n">other</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_wrap</span><span class="p">([</span><span class="s1">&#39;&lt;same as local_measures&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">remain</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_wrap</span><span class="p">(</span><span class="n">list_</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_wrap</span><span class="p">(</span><span class="n">list_</span><span class="p">))</span>

        <span class="n">infostr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">infostr</span></div></div>
        <span class="c1"># print(infostr)</span>


<div class="viewcode-block" id="testdata_annot_metadata"><a class="viewcode-back" href="../../vtool.html#vtool.matching.testdata_annot_metadata">[docs]</a><span class="k">def</span> <span class="nf">testdata_annot_metadata</span><span class="p">(</span><span class="n">rchip_fpath</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">LazyDict</span><span class="p">({</span><span class="s1">&#39;rchip_fpath&#39;</span><span class="p">:</span> <span class="n">rchip_fpath</span><span class="p">})</span>
    <span class="n">ensure_metadata_feats</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="ensure_metadata_vsone"><a class="viewcode-back" href="../../vtool.html#vtool.matching.ensure_metadata_vsone">[docs]</a><span class="k">def</span> <span class="nf">ensure_metadata_vsone</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">annot2</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">ensure_metadata_feats</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>
    <span class="n">ensure_metadata_feats</span><span class="p">(</span><span class="n">annot2</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>

    <span class="p">(</span><span class="n">symmetric</span><span class="p">,)</span> <span class="o">=</span> <span class="n">PairwiseMatch</span><span class="o">.</span><span class="n">_take_params</span><span class="p">(</span><span class="n">cfgdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;symmetric&#39;</span><span class="p">])</span>

    <span class="n">ensure_metadata_flann</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">symmetric</span><span class="p">:</span>
        <span class="n">ensure_metadata_flann</span><span class="p">(</span><span class="n">annot2</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="n">cfgdict</span><span class="p">)</span>
    <span class="n">ensure_metadata_dlen_sqrd</span><span class="p">(</span><span class="n">annot2</span><span class="p">)</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ensure_metadata_normxy"><a class="viewcode-back" href="../../vtool.html#vtool.matching.ensure_metadata_normxy">[docs]</a><span class="k">def</span> <span class="nf">ensure_metadata_normxy</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="k">if</span> <span class="s1">&#39;norm_xys&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">eval_normxy</span><span class="p">():</span>
            <span class="n">xys</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">get_xys</span><span class="p">(</span><span class="n">annot</span><span class="p">[</span><span class="s1">&#39;kpts&#39;</span><span class="p">])</span>
            <span class="n">chip_wh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">annot</span><span class="p">[</span><span class="s1">&#39;chip_size&#39;</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">xys</span> <span class="o">/</span> <span class="n">chip_wh</span>

        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="s1">&#39;norm_xys&#39;</span><span class="p">,</span> <span class="n">eval_normxy</span><span class="p">)</span></div>


<div class="viewcode-block" id="ensure_metadata_feats"><a class="viewcode-back" href="../../vtool.html#vtool.matching.ensure_metadata_feats">[docs]</a><span class="k">def</span> <span class="nf">ensure_metadata_feats</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">cfgdict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds feature evaluation keys to a lazy dictionary</span>

<span class="sd">    Args:</span>
<span class="sd">        annot (utool.LazyDict):</span>
<span class="sd">        suffix (str): (default = &#39;&#39;)</span>
<span class="sd">        cfgdict (dict): (default = {})</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.matching --exec-ensure_metadata_feats</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(module:pyhesaff)</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; rchip_fpath = ut.grab_test_imgpath(&#39;easy1.png&#39;)</span>
<span class="sd">        &gt;&gt;&gt; annot = ut.LazyDict({&#39;rchip_fpath&#39;: rchip_fpath})</span>
<span class="sd">        &gt;&gt;&gt; cfgdict = {}</span>
<span class="sd">        &gt;&gt;&gt; ensure_metadata_feats(annot, cfgdict)</span>
<span class="sd">        &gt;&gt;&gt; assert len(annot._stored_results) == 1</span>
<span class="sd">        &gt;&gt;&gt; annot[&#39;kpts&#39;]</span>
<span class="sd">        &gt;&gt;&gt; assert len(annot._stored_results) &gt;= 4</span>
<span class="sd">        &gt;&gt;&gt; annot[&#39;vecs&#39;]</span>
<span class="sd">        &gt;&gt;&gt; assert len(annot._stored_results) &gt;= 5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">rchip_key</span> <span class="o">=</span> <span class="s1">&#39;rchip&#39;</span>
    <span class="n">nchip_key</span> <span class="o">=</span> <span class="s1">&#39;nchip&#39;</span>
    <span class="n">_feats_key</span> <span class="o">=</span> <span class="s1">&#39;_feats&#39;</span>
    <span class="n">kpts_key</span> <span class="o">=</span> <span class="s1">&#39;kpts&#39;</span>
    <span class="n">vecs_key</span> <span class="o">=</span> <span class="s1">&#39;vecs&#39;</span>
    <span class="n">rchip_fpath_key</span> <span class="o">=</span> <span class="s1">&#39;rchip_fpath&#39;</span>

    <span class="k">if</span> <span class="n">rchip_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">eval_rchip</span><span class="p">():</span>
            <span class="n">rchip_fpath</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="n">rchip_fpath_key</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">vt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">rchip_fpath</span><span class="p">)</span>

        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="n">rchip_key</span><span class="p">,</span> <span class="n">eval_rchip</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nchip_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">eval_normchip</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EVAL NORMCHIP&#39;</span><span class="p">)</span>
            <span class="c1"># Hack in normalization (hack because rchip might already</span>
            <span class="c1"># be normalized)</span>
            <span class="n">filter_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">pi</span><span class="o">.</span><span class="n">varname</span><span class="p">:</span> <span class="p">(</span><span class="n">cfgdict</span><span class="p">[</span><span class="n">pi</span><span class="o">.</span><span class="n">varname</span><span class="p">]</span> <span class="k">if</span> <span class="n">pi</span><span class="o">.</span><span class="n">varname</span> <span class="ow">in</span> <span class="n">cfgdict</span> <span class="k">else</span> <span class="n">pi</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="n">NORM_CHIP_CONFIG</span>
            <span class="p">}</span>
            <span class="c1"># new way</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;histeq&#39;</span><span class="p">]:</span>
                <span class="n">filter_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;histeq&#39;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;medianblur&#39;</span><span class="p">]:</span>
                <span class="n">filter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;medianblur&#39;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;noise_thresh&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;medianblur_thresh&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;ksize1&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;medianblur_ksize1&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;ksize2&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;medianblur_ksize2&#39;</span><span class="p">],</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;adapteq&#39;</span><span class="p">]:</span>
                <span class="n">ksize</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;adapteq_ksize&#39;</span><span class="p">]</span>
                <span class="n">filter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s1">&#39;adapteq&#39;</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;tileGridSize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">ksize</span><span class="p">,</span> <span class="n">ksize</span><span class="p">),</span>
                            <span class="s1">&#39;clipLimit&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;adapteq_limit&#39;</span><span class="p">],</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">rchip</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="n">rchip_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filter_list</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">vtool</span> <span class="kn">import</span> <span class="n">image_filters</span>

                <span class="n">ipreproc</span> <span class="o">=</span> <span class="n">image_filters</span><span class="o">.</span><span class="n">IntensityPreproc</span><span class="p">()</span>
                <span class="n">nchip</span> <span class="o">=</span> <span class="n">ipreproc</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">rchip</span><span class="p">,</span> <span class="n">filter_list</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nchip</span> <span class="o">=</span> <span class="n">rchip</span>
            <span class="k">return</span> <span class="n">nchip</span>

        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="n">nchip_key</span><span class="p">,</span> <span class="n">eval_normchip</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kpts_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annot</span> <span class="ow">or</span> <span class="n">vecs_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">eval_feats</span><span class="p">():</span>
            <span class="n">rchip</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="n">nchip_key</span><span class="p">]</span>
            <span class="n">feat_cfgkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">pi</span><span class="o">.</span><span class="n">varname</span> <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="n">VSONE_FEAT_CONFIG</span><span class="p">]</span>
            <span class="n">feat_cfgdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">cfgdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">feat_cfgkeys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cfgdict</span><span class="p">}</span>
            <span class="n">_feats</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">rchip</span><span class="p">,</span> <span class="o">**</span><span class="n">feat_cfgdict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_feats</span>

        <span class="k">def</span> <span class="nf">eval_kpts</span><span class="p">():</span>
            <span class="n">_feats</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="n">_feats_key</span><span class="p">]</span>
            <span class="n">kpts</span> <span class="o">=</span> <span class="n">_feats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">kpts</span>

        <span class="k">def</span> <span class="nf">eval_vecs</span><span class="p">():</span>
            <span class="n">_feats</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="n">_feats_key</span><span class="p">]</span>
            <span class="n">vecs</span> <span class="o">=</span> <span class="n">_feats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">vecs</span>

        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="n">_feats_key</span><span class="p">,</span> <span class="n">eval_feats</span><span class="p">)</span>
        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="n">kpts_key</span><span class="p">,</span> <span class="n">eval_kpts</span><span class="p">)</span>
        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="n">vecs_key</span><span class="p">,</span> <span class="n">eval_vecs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annot</span></div>


<div class="viewcode-block" id="ensure_metadata_dlen_sqrd"><a class="viewcode-back" href="../../vtool.html#vtool.matching.ensure_metadata_dlen_sqrd">[docs]</a><span class="k">def</span> <span class="nf">ensure_metadata_dlen_sqrd</span><span class="p">(</span><span class="n">annot</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;dlen_sqrd&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">eval_dlen_sqrd</span><span class="p">(</span><span class="n">annot</span><span class="p">):</span>
            <span class="n">rchip</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s1">&#39;rchip&#39;</span><span class="p">]</span>
            <span class="n">dlen_sqrd</span> <span class="o">=</span> <span class="n">rchip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">rchip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">dlen_sqrd</span>

        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="s1">&#39;dlen_sqrd&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">eval_dlen_sqrd</span><span class="p">(</span><span class="n">annot</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">annot</span></div>


<div class="viewcode-block" id="ensure_metadata_flann"><a class="viewcode-back" href="../../vtool.html#vtool.matching.ensure_metadata_flann">[docs]</a><span class="k">def</span> <span class="nf">ensure_metadata_flann</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">cfgdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;setup lazy flann evaluation&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="n">flann_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;kdtree&#39;</span><span class="p">,</span> <span class="s1">&#39;trees&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

    <span class="k">if</span> <span class="s1">&#39;flann&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annot</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">eval_flann</span><span class="p">():</span>
            <span class="n">vecs</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_flann</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_flann</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">flann_cache</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="n">flann_params</span><span class="o">=</span><span class="n">flann_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_flann</span>

        <span class="n">annot</span><span class="o">.</span><span class="n">set_lazy_func</span><span class="p">(</span><span class="s1">&#39;flann&#39;</span><span class="p">,</span> <span class="n">eval_flann</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">annot</span></div>


<div class="viewcode-block" id="empty_neighbors"><a class="viewcode-back" href="../../vtool.html#vtool.matching.empty_neighbors">[docs]</a><span class="k">def</span> <span class="nf">empty_neighbors</span><span class="p">(</span><span class="n">num_vecs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_vecs</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">fx2_to_fx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">_fx2_to_dist_sqrd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">_fx2_to_dist_sqrd</span></div>


<span class="c1"># maximum SIFT matching distance based using uint8 trick from hesaff</span>
<span class="n">PSEUDO_MAX_VEC_COMPONENT</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">PSEUDO_MAX_DIST_SQRD</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">PSEUDO_MAX_VEC_COMPONENT</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">PSEUDO_MAX_DIST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">PSEUDO_MAX_VEC_COMPONENT</span><span class="p">)</span>


<div class="viewcode-block" id="empty_assign"><a class="viewcode-back" href="../../vtool.html#vtool.matching.empty_assign">[docs]</a><span class="k">def</span> <span class="nf">empty_assign</span><span class="p">():</span>
    <span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">match_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">fx1_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">fx2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fm</span><span class="p">,</span> <span class="n">match_dist</span><span class="p">,</span> <span class="n">norm_dist</span><span class="p">,</span> <span class="n">fx1_norm</span><span class="p">,</span> <span class="n">fx2_norm</span></div>


<div class="viewcode-block" id="symmetric_correspondence"><a class="viewcode-back" href="../../vtool.html#vtool.matching.symmetric_correspondence">[docs]</a><span class="k">def</span> <span class="nf">symmetric_correspondence</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">annot2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="p">,</span> <span class="n">checks</span><span class="p">,</span> <span class="n">allow_shrink</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find symmetric feature corresopndences</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">allow_shrink</span><span class="p">:</span>
        <span class="c1"># Reduce K to allow some correspondences to be established</span>
        <span class="n">n_have</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">n_have</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">empty_assign</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">n_have</span> <span class="o">&lt;</span> <span class="n">K</span> <span class="o">+</span> <span class="n">Knorm</span><span class="p">:</span>
            <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span> <span class="o">=</span> <span class="n">n_have</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">num_neighbors</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">Knorm</span>

    <span class="n">fx1_to_fx2</span><span class="p">,</span> <span class="n">fx1_to_dist</span> <span class="o">=</span> <span class="n">normalized_nearest_neighbors</span><span class="p">(</span>
        <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;flann&#39;</span><span class="p">],</span> <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">],</span> <span class="n">num_neighbors</span><span class="p">,</span> <span class="n">checks</span>
    <span class="p">)</span>

    <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx2_to_dist</span> <span class="o">=</span> <span class="n">normalized_nearest_neighbors</span><span class="p">(</span>
        <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;flann&#39;</span><span class="p">],</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">],</span> <span class="n">num_neighbors</span><span class="p">,</span> <span class="n">checks</span>
    <span class="p">)</span>

    <span class="c1"># fx2_to_flags = flag_symmetric_matches(fx2_to_fx1, fx1_to_fx2, K)</span>

    <span class="n">assigntup2</span> <span class="o">=</span> <span class="n">assign_symmetric_matches</span><span class="p">(</span>
        <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx2_to_dist</span><span class="p">,</span> <span class="n">fx1_to_fx2</span><span class="p">,</span> <span class="n">fx1_to_dist</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span>
    <span class="p">)</span>

    <span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">match_dist</span><span class="p">,</span> <span class="n">fx1_norm</span><span class="p">,</span> <span class="n">norm_dist1</span><span class="p">,</span> <span class="n">fx2_norm</span><span class="p">,</span> <span class="n">norm_dist2</span><span class="p">)</span> <span class="o">=</span> <span class="n">assigntup2</span>
    <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">norm_dist1</span><span class="p">,</span> <span class="n">norm_dist2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fm</span><span class="p">,</span> <span class="n">match_dist</span><span class="p">,</span> <span class="n">norm_dist</span><span class="p">,</span> <span class="n">fx1_norm</span><span class="p">,</span> <span class="n">fx2_norm</span></div>


<div class="viewcode-block" id="asymmetric_correspondence"><a class="viewcode-back" href="../../vtool.html#vtool.matching.asymmetric_correspondence">[docs]</a><span class="k">def</span> <span class="nf">asymmetric_correspondence</span><span class="p">(</span><span class="n">annot1</span><span class="p">,</span> <span class="n">annot2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="p">,</span> <span class="n">checks</span><span class="p">,</span> <span class="n">allow_shrink</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find symmetric feature corresopndences</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">allow_shrink</span><span class="p">:</span>
        <span class="c1"># Reduce K to allow some correspondences to be established</span>
        <span class="n">n_have</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">n_have</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">empty_assign</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">n_have</span> <span class="o">&lt;</span> <span class="n">K</span> <span class="o">+</span> <span class="n">Knorm</span><span class="p">:</span>
            <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span> <span class="o">=</span> <span class="n">n_have</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">num_neighbors</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">Knorm</span>

    <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx2_to_dist</span> <span class="o">=</span> <span class="n">normalized_nearest_neighbors</span><span class="p">(</span>
        <span class="n">annot1</span><span class="p">[</span><span class="s1">&#39;flann&#39;</span><span class="p">],</span> <span class="n">annot2</span><span class="p">[</span><span class="s1">&#39;vecs&#39;</span><span class="p">],</span> <span class="n">num_neighbors</span><span class="p">,</span> <span class="n">checks</span>
    <span class="p">)</span>
    <span class="n">fx2_to_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">),</span> <span class="n">K</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
    <span class="c1"># Assign correspondences</span>
    <span class="n">assigntup</span> <span class="o">=</span> <span class="n">assign_unconstrained_matches</span><span class="p">(</span>
        <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx2_to_dist</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="p">,</span> <span class="n">fx2_to_flags</span>
    <span class="p">)</span>
    <span class="n">fm</span><span class="p">,</span> <span class="n">match_dist</span><span class="p">,</span> <span class="n">fx1_norm</span><span class="p">,</span> <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">assigntup</span>
    <span class="n">fx2_norm</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">fm</span><span class="p">,</span> <span class="n">match_dist</span><span class="p">,</span> <span class="n">norm_dist</span><span class="p">,</span> <span class="n">fx1_norm</span><span class="p">,</span> <span class="n">fx2_norm</span></div>


<div class="viewcode-block" id="normalized_nearest_neighbors"><a class="viewcode-back" href="../../vtool.html#vtool.matching.normalized_nearest_neighbors">[docs]</a><span class="k">def</span> <span class="nf">normalized_nearest_neighbors</span><span class="p">(</span><span class="n">flann1</span><span class="p">,</span> <span class="n">vecs2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="mi">800</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes matches from vecs2 to flann1.</span>

<span class="sd">    uses flann index to return nearest neighbors with distances normalized</span>
<span class="sd">    between 0 and 1 using sifts uint8 trick</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

    <span class="k">if</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">_fx2_to_dist_sqrd</span><span class="p">)</span> <span class="o">=</span> <span class="n">empty_neighbors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vecs2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">vecs2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">_fx2_to_dist_sqrd</span><span class="p">)</span> <span class="o">=</span> <span class="n">empty_neighbors</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">flann1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">_fx2_to_dist_sqrd</span><span class="p">)</span> <span class="o">=</span> <span class="n">empty_neighbors</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">K</span> <span class="o">&gt;</span> <span class="n">flann1</span><span class="o">.</span><span class="n">get_indexed_shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Corner case, may be better to throw an assertion error</span>
        <span class="k">raise</span> <span class="n">MatchingError</span><span class="p">(</span><span class="s1">&#39;not enough database features&#39;</span><span class="p">)</span>
        <span class="c1"># (fx2_to_fx1, _fx2_to_dist_sqrd) = empty_neighbors(len(vecs2), 0)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">_fx2_to_dist_sqrd</span> <span class="o">=</span> <span class="n">flann1</span><span class="o">.</span><span class="n">nn_index</span><span class="p">(</span>
            <span class="n">vecs2</span><span class="p">,</span> <span class="n">num_neighbors</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="n">checks</span>
        <span class="p">)</span>
    <span class="n">_fx2_to_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_fx2_to_dist_sqrd</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
    <span class="c1"># normalized SIFT dist</span>
    <span class="n">fx2_to_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">_fx2_to_dist</span><span class="p">,</span> <span class="n">PSEUDO_MAX_DIST</span><span class="p">)</span>
    <span class="n">fx2_to_fx1</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">atleast_nd</span><span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">fx2_to_dist</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">atleast_nd</span><span class="p">(</span><span class="n">fx2_to_dist</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx2_to_dist</span></div>


<div class="viewcode-block" id="assign_symmetric_matches"><a class="viewcode-back" href="../../vtool.html#vtool.matching.assign_symmetric_matches">[docs]</a><span class="k">def</span> <span class="nf">assign_symmetric_matches</span><span class="p">(</span>
    <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx2_to_dist</span><span class="p">,</span> <span class="n">fx1_to_fx2</span><span class="p">,</span> <span class="n">fx1_to_dist</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ignore:</span>
<span class="sd">        &gt;&gt;&gt; import vtool as vt</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *</span>
<span class="sd">        &gt;&gt;&gt; K = 2</span>
<span class="sd">        &gt;&gt;&gt; Knorm = 1</span>
<span class="sd">        &gt;&gt;&gt; feat1 = np.random.rand(5, 3)</span>
<span class="sd">        &gt;&gt;&gt; feat2 = np.random.rand(7, 3)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Assign distances</span>
<span class="sd">        &gt;&gt;&gt; distmat = vt.L2(feat1[:, None], feat2[None, :])</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Find nearest K</span>
<span class="sd">        &gt;&gt;&gt; fx1_to_fx2 = distmat.argsort()[:, 0:K + Knorm]</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_fx1 = distmat.T.argsort()[:, 0:K + Knorm]</span>
<span class="sd">        &gt;&gt;&gt; # and order their distances</span>
<span class="sd">        &gt;&gt;&gt; fx1_to_dist = np.array([distmat[i].take(col) for i, col in enumerate(fx1_to_fx2)])</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_dist = np.array([distmat.T[j].take(row) for j, row in enumerate(fx2_to_fx1)])</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # flat_matx1 = fx1_to_fx2 + np.arange(distmat.shape[0])[:, None] * distmat.shape[1]</span>
<span class="sd">        &gt;&gt;&gt; # fx1_to_dist = distmat.take(flat_matx1).reshape(fx1_to_fx2.shape)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; fx21 = pd.DataFrame(fx2_to_fx1)</span>
<span class="sd">        &gt;&gt;&gt; fx21.columns.name = &#39;K&#39;</span>
<span class="sd">        &gt;&gt;&gt; fx21.index.name = &#39;fx1&#39;</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; fx12 = pd.DataFrame(fx1_to_fx2)</span>
<span class="sd">        &gt;&gt;&gt; fx12.columns.name = &#39;K&#39;</span>
<span class="sd">        &gt;&gt;&gt; fx12.index.name = &#39;fx2&#39;</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; fx12 = fx12.T[0:K].T.astype(np.float)</span>
<span class="sd">        &gt;&gt;&gt; fx21 = fx21.T[0:K].T.astype(np.float)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; fx12.values[~fx1_to_flags] = np.nan</span>
<span class="sd">        &gt;&gt;&gt; fx21.values[~fx2_to_flags] = np.nan</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;fx12.values =\n%r&#39; % (fx12,))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;fm_ =\n%r&#39; % (fm_,))</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;fx21.values =\n%r&#39; % (fx21,))</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;fm =\n%r&#39; % (fm,))</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; unflat_match_idx2 = -np.ones(fx2_to_fx1.shape)</span>
<span class="sd">        &gt;&gt;&gt; unflat_match_idx2.ravel()[flat_match_idx2] = flat_match_idx2</span>
<span class="sd">        &gt;&gt;&gt; inv_lookup21 = unflat_match_idx2.T[0:K].T</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; for fx2 in zip(fx12.values[fx1_to_flags]:</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; for fx1, fx2 in zip(match_fx1_, match_fx2_):</span>
<span class="sd">        &gt;&gt;&gt;     cx = np.where(fx2_to_fx1[fx2][0:K] == fx1)[0][0]</span>
<span class="sd">        &gt;&gt;&gt;     inv_idx = inv_lookup21[fx2][cx]</span>
<span class="sd">        &gt;&gt;&gt;     print(&#39;inv_idx = %r&#39; % (inv_idx,))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Infer the valid internal query feature indexes and ranks</span>
    <span class="k">if</span> <span class="n">Knorm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basic_norm_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basic_norm_rank</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">Knorm</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">index_dtype</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">dtype</span>

    <span class="n">fx2_to_flags</span> <span class="o">=</span> <span class="n">flag_symmetric_matches</span><span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx1_to_fx2</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">flat_validx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">fx2_to_flags</span><span class="p">)</span>
    <span class="n">match_fx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="n">flat_validx2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
    <span class="n">match_rank2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">flat_validx2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
    <span class="n">flat_match_idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span>
        <span class="p">(</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">match_rank2</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">)</span>
    <span class="n">match_fx1</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_match_idx2</span><span class="p">)</span>
    <span class="n">match_dist1</span> <span class="o">=</span> <span class="n">fx2_to_dist</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_match_idx2</span><span class="p">)</span>

    <span class="c1"># assert np.all(match_dist1 == fx2_to_dist[:, 0:K][fx2_to_flags])</span>

    <span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">match_fx1</span><span class="p">,</span> <span class="n">match_fx2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># TODO: for each position in fm need to find corresponding position in fm_</span>

    <span class="c1"># Currently just use the last one as a normalizer</span>
    <span class="n">norm_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basic_norm_rank</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_fx2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">match_fx2</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="c1"># norm_rank = basic_norm_rank</span>
    <span class="n">flat_norm_idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">norm_rank</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">norm_fx1</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_norm_idx1</span><span class="p">)</span>
    <span class="n">norm_dist1</span> <span class="o">=</span> <span class="n">fx2_to_dist</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_norm_idx1</span><span class="p">)</span>
    <span class="n">norm_fx1</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="p">[</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">norm_rank</span><span class="p">]</span>
    <span class="n">norm_dist1</span> <span class="o">=</span> <span class="n">fx2_to_dist</span><span class="p">[</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">norm_rank</span><span class="p">]</span>

    <span class="c1"># ---------</span>
    <span class="c1"># REVERSE DIRECTION</span>
    <span class="n">fx1_to_flags</span> <span class="o">=</span> <span class="n">flag_symmetric_matches</span><span class="p">(</span><span class="n">fx1_to_fx2</span><span class="p">,</span> <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">flat_validx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">fx1_to_flags</span><span class="p">)</span>
    <span class="n">match_fx1_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="n">flat_validx1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
    <span class="n">match_rank1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">flat_validx1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
    <span class="n">flat_match_idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">(</span>
        <span class="p">(</span><span class="n">match_fx1_</span><span class="p">,</span> <span class="n">match_rank1</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">fx1_to_fx2</span><span class="o">.</span><span class="n">shape</span>
    <span class="p">)</span>
    <span class="n">match_fx2_</span> <span class="o">=</span> <span class="n">fx1_to_fx2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_match_idx1</span><span class="p">)</span>
    <span class="c1"># match_dist2_ = fx1_to_dist.take(flat_match_idx1)</span>
    <span class="n">fm_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">match_fx1_</span><span class="p">,</span> <span class="n">match_fx2_</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="n">flat_norm_idx2_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">match_fx1_</span><span class="p">,</span> <span class="n">norm_rank</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">fx1_to_fx2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">norm_fx2_</span> <span class="o">=</span> <span class="n">fx1_to_fx2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_norm_idx2_</span><span class="p">)</span>
    <span class="n">norm_dist2_</span> <span class="o">=</span> <span class="n">fx1_to_dist</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_norm_idx2_</span><span class="p">)</span>

    <span class="c1"># ---------</span>
    <span class="c1"># Align matches with the reverse direction</span>

    <span class="c1"># Do this by enforcing a constant sorting. No lookup necessary</span>
    <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">sortx_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="n">fm_</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="c1"># fm2_ = fm_.take(sortx_, axis=0)</span>
    <span class="c1"># assert np.all(fm2 == fm2_)</span>

    <span class="n">a_fm</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">a_match_dist</span> <span class="o">=</span> <span class="n">match_dist1</span><span class="p">[</span><span class="n">sortx</span><span class="p">]</span>
    <span class="c1"># assert np.all(match_dist1[sortx] == match_dist2_[sortx_])</span>

    <span class="n">a_norm_fx1</span> <span class="o">=</span> <span class="n">norm_fx1</span><span class="p">[</span><span class="n">sortx</span><span class="p">]</span>
    <span class="n">a_norm_dist1</span> <span class="o">=</span> <span class="n">norm_dist1</span><span class="p">[</span><span class="n">sortx</span><span class="p">]</span>

    <span class="n">a_norm_fx2_</span> <span class="o">=</span> <span class="n">norm_fx2_</span><span class="p">[</span><span class="n">sortx_</span><span class="p">]</span>
    <span class="n">a_norm_dist2_</span> <span class="o">=</span> <span class="n">norm_dist2_</span><span class="p">[</span><span class="n">sortx_</span><span class="p">]</span>

    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a_norm_dist2_</span><span class="p">,</span> <span class="n">a_norm_dist1</span><span class="p">)</span>

    <span class="n">assigntup</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_fm</span><span class="p">,</span> <span class="n">a_match_dist</span><span class="p">,</span> <span class="n">a_norm_fx1</span><span class="p">,</span> <span class="n">a_norm_dist1</span><span class="p">,</span> <span class="n">a_norm_fx2_</span><span class="p">,</span> <span class="n">a_norm_dist2_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">assigntup</span></div>


<div class="viewcode-block" id="assign_unconstrained_matches"><a class="viewcode-back" href="../../vtool.html#vtool.matching.assign_unconstrained_matches">[docs]</a><span class="k">def</span> <span class="nf">assign_unconstrained_matches</span><span class="p">(</span>
    <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx2_to_dist</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Knorm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fx2_to_flags</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    assigns vsone matches using results of nearest neighbors.</span>

<span class="sd">    Ignore:</span>
<span class="sd">        fx2_to_dist = np.arange(fx2_to_fx1.size).reshape(fx2_to_fx1.shape)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.matching --test-assign_unconstrained_matches --show</span>
<span class="sd">        python -m vtool.matching assign_unconstrained_matches:0</span>
<span class="sd">        python -m vtool.matching assign_unconstrained_matches:1</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_fx1, fx2_to_dist = empty_neighbors(0, 0)</span>
<span class="sd">        &gt;&gt;&gt; K = 1</span>
<span class="sd">        &gt;&gt;&gt; Knorm = 1</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_flags = None</span>
<span class="sd">        &gt;&gt;&gt; assigntup = assign_unconstrained_matches(fx2_to_fx1, fx2_to_dist, K,</span>
<span class="sd">        &gt;&gt;&gt;                                          Knorm, fx2_to_flags)</span>
<span class="sd">        &gt;&gt;&gt; fm, match_dist, norm_fx1, norm_dist = assigntup</span>
<span class="sd">        &gt;&gt;&gt; result = ub.repr2(assigntup, precision=3, nobr=True, with_dtype=True)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_fx1 = np.array([[ 77,   971, 22],</span>
<span class="sd">        &gt;&gt;&gt;                        [116,   120, 34],</span>
<span class="sd">        &gt;&gt;&gt;                        [122,   128, 99],</span>
<span class="sd">        &gt;&gt;&gt;                        [1075,  692, 102],</span>
<span class="sd">        &gt;&gt;&gt;                        [ 530,   45, 120],</span>
<span class="sd">        &gt;&gt;&gt;                        [  45,  530, 77]], dtype=np.int32)</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_dist = np.array([[ 0.059,  0.238, .3],</span>
<span class="sd">        &gt;&gt;&gt;                         [ 0.021,  0.240, .4],</span>
<span class="sd">        &gt;&gt;&gt;                         [ 0.039,  0.247, .5],</span>
<span class="sd">        &gt;&gt;&gt;                         [ 0.149,  0.151, .6],</span>
<span class="sd">        &gt;&gt;&gt;                         [ 0.226,  0.244, .7],</span>
<span class="sd">        &gt;&gt;&gt;                         [ 0.215,  0.236, .8]], dtype=np.float32)</span>
<span class="sd">        &gt;&gt;&gt; K = 1</span>
<span class="sd">        &gt;&gt;&gt; Knorm = 1</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_flags = np.array([[1, 1], [0, 1], [1, 1], [0, 1], [1, 1], [1, 1]])</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_flags = fx2_to_flags[:, 0:K]</span>
<span class="sd">        &gt;&gt;&gt; assigntup = assign_unconstrained_matches(fx2_to_fx1, fx2_to_dist, K,</span>
<span class="sd">        &gt;&gt;&gt;                                          Knorm, fx2_to_flags)</span>
<span class="sd">        &gt;&gt;&gt; fm, match_dist, norm_fx1, norm_dist = assigntup</span>
<span class="sd">        &gt;&gt;&gt; result = ub.repr2(assigntup, precision=3, nobr=True, with_dtype=True)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; assert len(fm.shape) == 2 and fm.shape[1] == 2</span>
<span class="sd">        &gt;&gt;&gt; assert ub.allsame(list(map(len, assigntup)))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Infer the valid internal query feature indexes and ranks</span>
    <span class="n">index_dtype</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">dtype</span>

    <span class="k">if</span> <span class="n">fx2_to_flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># make everything valid</span>
        <span class="n">flat_validx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># fx2_to_flags = np.ones((len(fx2_to_fx1), K), dtype=np.bool_)</span>
        <span class="n">flat_validx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">fx2_to_flags</span><span class="p">)</span>

    <span class="n">match_fx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="n">flat_validx</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>
    <span class="n">match_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">flat_validx</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">index_dtype</span><span class="p">)</span>

    <span class="n">flat_match_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">match_rank</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">match_fx1</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_match_idx</span><span class="p">)</span>
    <span class="n">match_dist</span> <span class="o">=</span> <span class="n">fx2_to_dist</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_match_idx</span><span class="p">)</span>

    <span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">match_fx1</span><span class="p">,</span> <span class="n">match_fx2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">Knorm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basic_norm_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basic_norm_rank</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="n">Knorm</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Currently just use the last one as a normalizer</span>
    <span class="n">norm_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">basic_norm_rank</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_fx2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">match_fx2</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">flat_norm_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel_multi_index</span><span class="p">((</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">norm_rank</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">norm_fx1</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_norm_idx</span><span class="p">)</span>
    <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">fx2_to_dist</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">flat_norm_idx</span><span class="p">)</span>
    <span class="n">norm_fx1</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="p">[</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">norm_rank</span><span class="p">]</span>
    <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">fx2_to_dist</span><span class="p">[</span><span class="n">match_fx2</span><span class="p">,</span> <span class="n">norm_rank</span><span class="p">]</span>

    <span class="n">assigntup</span> <span class="o">=</span> <span class="n">AssignTup</span><span class="p">(</span><span class="n">fm</span><span class="p">,</span> <span class="n">match_dist</span><span class="p">,</span> <span class="n">norm_fx1</span><span class="p">,</span> <span class="n">norm_dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">assigntup</span></div>


<div class="viewcode-block" id="flag_sym_slow"><a class="viewcode-back" href="../../vtool.html#vtool.matching.flag_sym_slow">[docs]</a><span class="k">def</span> <span class="nf">flag_sym_slow</span><span class="p">(</span><span class="n">fx1_to_fx2</span><span class="p">,</span> <span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns flags indicating if the matches in fx1_to_fx2 are reciprocal</span>
<span class="sd">    with the matches in fx2_to_fx1.</span>

<span class="sd">    Much slower version of flag_symmetric_matches, but more clear</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fx1_to_flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fx1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fx1_to_fx2</span><span class="p">)):</span>
        <span class="c1"># Find img2 features in fx1&#39;s top K</span>
        <span class="n">fx2_m</span> <span class="o">=</span> <span class="n">fx1_to_fx2</span><span class="p">[</span><span class="n">fx1</span><span class="p">,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span>
        <span class="c1"># Find img2 features that have fx1 in their top K</span>
        <span class="n">reverse_m</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="p">[</span><span class="n">fx2_m</span><span class="p">,</span> <span class="p">:</span><span class="n">K</span><span class="p">]</span>
        <span class="n">is_recip</span> <span class="o">=</span> <span class="p">(</span><span class="n">reverse_m</span> <span class="o">==</span> <span class="n">fx1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="n">fx1_to_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_recip</span><span class="p">)</span>
    <span class="n">fx1_to_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fx1_to_flags</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fx1_to_flags</span></div>


<div class="viewcode-block" id="flag_symmetric_matches"><a class="viewcode-back" href="../../vtool.html#vtool.matching.flag_symmetric_matches">[docs]</a><span class="k">def</span> <span class="nf">flag_symmetric_matches</span><span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">,</span> <span class="n">fx1_to_fx2</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns flags indicating if the matches in fx2_to_fx1 are reciprocal</span>
<span class="sd">    with the matches in fx1_to_fx2.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.matching import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; K = 2</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_fx1 = np.array([[ 0,  1], # 0</span>
<span class="sd">        &gt;&gt;&gt;                        [ 1,  4], # 1</span>
<span class="sd">        &gt;&gt;&gt;                        [ 3,  4], # 2</span>
<span class="sd">        &gt;&gt;&gt;                        [ 2,  3]], dtype=np.int32) # 3</span>
<span class="sd">        &gt;&gt;&gt; fx1_to_fx2 = np.array([[ 0, 1], # 0</span>
<span class="sd">        &gt;&gt;&gt;                        [ 2, 1], # 1</span>
<span class="sd">        &gt;&gt;&gt;                        [ 0, 1], # 2</span>
<span class="sd">        &gt;&gt;&gt;                        [ 3, 1], # 3</span>
<span class="sd">        &gt;&gt;&gt;                        [ 0, 1]], dtype=np.int32) # 4</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_flagsA = flag_symmetric_matches(fx2_to_fx1, fx1_to_fx2, K)</span>
<span class="sd">        &gt;&gt;&gt; fx2_to_flagsB = flag_sym_slow(fx2_to_fx1, fx1_to_fx2, K)</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(fx2_to_flagsA == fx2_to_flagsB)</span>
<span class="sd">        &gt;&gt;&gt; result = ub.repr2(fx2_to_flagsB)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match_12</span> <span class="o">=</span> <span class="n">fx1_to_fx2</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">match_21</span> <span class="o">=</span> <span class="n">fx2_to_fx1</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="n">K</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">fx2_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match_21</span><span class="p">))</span>
    <span class="c1"># Lookup the reciprocal neighbors of each img2 feature.</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="n">match_12</span><span class="p">[</span><span class="n">match_21</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
    <span class="c1"># Group the reciprocal matches such that</span>
    <span class="c1"># matches[fx2, k, i] is the i-th recip neighbor of the k-th neighbor of fx</span>
    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fx2_to_fx1</span><span class="p">),</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>
    <span class="c1"># If a reciprocal neighbor is itself, then the feature is good</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">matched</span> <span class="o">==</span> <span class="n">fx2_list</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">fx2_to_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fx2_to_flags</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        python ~/code/vtool/vtool/matching.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xdoctest</span>

    <span class="n">xdoctest</span><span class="o">.</span><span class="n">doctest_module</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Wild Me.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>