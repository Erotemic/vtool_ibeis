
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>vtool.confusion &#8212; wbia-vtool 3.2.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for vtool.confusion</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for -- Confusion matrix, contingency, error matrix,</span>

<span class="sd">References:</span>
<span class="sd">    http://en.wikipedia.org/wiki/Confusion_matrix</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">utool</span> <span class="k">as</span> <span class="nn">ut</span>
<span class="kn">import</span> <span class="nn">ubelt</span> <span class="k">as</span> <span class="nn">ub</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>


<div class="viewcode-block" id="testdata_scores_labels"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.testdata_scores_labels">[docs]</a><span class="k">def</span> <span class="nf">testdata_scores_labels</span><span class="p">():</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">,</span>
        <span class="mi">6</span><span class="p">,</span>
        <span class="mi">9</span><span class="p">,</span>
        <span class="mi">9</span><span class="p">,</span>
        <span class="mi">13</span><span class="p">,</span>
        <span class="mi">17</span><span class="p">,</span>
        <span class="mi">19</span><span class="p">,</span>
        <span class="mi">22</span><span class="p">,</span>
        <span class="mi">22</span><span class="p">,</span>
        <span class="mi">23</span><span class="p">,</span>
        <span class="mi">26</span><span class="p">,</span>
        <span class="mi">26</span><span class="p">,</span>
        <span class="mi">34</span><span class="p">,</span>
        <span class="mi">59</span><span class="p">,</span>
        <span class="mi">63</span><span class="p">,</span>
        <span class="mi">75</span><span class="p">,</span>
        <span class="mi">80</span><span class="p">,</span>
        <span class="mi">81</span><span class="p">,</span>
        <span class="mi">89</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels</span></div>


<div class="viewcode-block" id="nan_to_num"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.nan_to_num">[docs]</a><span class="k">def</span> <span class="nf">nan_to_num</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">num</span>
    <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="ConfusionMetrics"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics">[docs]</a><span class="k">class</span> <span class="nc">ConfusionMetrics</span><span class="p">(</span><span class="n">ub</span><span class="o">.</span><span class="n">NiceRepr</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Can compute average percision using the PASCAL definition</span>

<span class="sd">    References:</span>
<span class="sd">        http://www.flinders.edu.au/science_engineering/fms/School-CSEM/publications/tech_reps-research_artfcts/TRRA_2007.pdf</span>
<span class="sd">        http://www.alta.asn.au/events/altss_w2003_proc/altss/courses/powers/Bookmaker-all/200302-ICCS-Bookmaker.pdfcs</span>
<span class="sd">        http://www.cs.bris.ac.uk/Publications/Papers/1000704.pdf</span>
<span class="sd">        http://en.wikipedia.org/wiki/Information_retrieval</span>
<span class="sd">        http://en.wikipedia.org/wiki/Precision_and_recall</span>
<span class="sd">        https://en.wikipedia.org/wiki/Confusion_matrix</span>
<span class="sd">        http://scikit-learn.org/stable/modules/generated/sklearn.metrics.roc_curve.html#sklearn.metrics.roc_curve</span>

<span class="sd">    SeeAlso:</span>
<span class="sd">        sklearn.metrics.ranking._binary_clf_curve</span>

<span class="sd">    Notes:</span>
<span class="sd">        From oxford:</span>
<span class="sd">        Precision is defined as the ratio of retrieved positive images to the</span>
<span class="sd">          total number retrieved.</span>
<span class="sd">        Recall is defined as the ratio of the number of retrieved positive</span>
<span class="sd">          images to the total number of positive images in the corpus.</span>

<span class="sd">    Ignore:</span>
<span class="sd">        varname_list = &#39;tp, fp, fn, tn, fpr, tpr, tpa&#39;.split(&#39;, &#39;)</span>
<span class="sd">        lines = [&#39;self.{varname} = {varname}&#39;.format(varname=varname) for varname in varname_list]</span>
<span class="sd">        print(ut.indent(&#39;\n&#39;.join(lines)))</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.confusion ConfusionMetrics --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; scores, labels = testdata_scores_labels()</span>
<span class="sd">        &gt;&gt;&gt; c = self = confusions = ConfusionMetrics().fit(scores, labels)</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(c.n_pos == c.n_tp + c.n_fn)</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(c.n_neg == c.n_tn + c.n_fp)</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.rp + c.rn, 1.0))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.pp + c.pn, 1.0))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.fpr, 1 - c.tnr))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.fnr, 1 - c.tpr))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.tpr, c.tp / c.rp))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.tpa, c.tp / c.pp))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.jacc, c.tp / (c.tp + c.fn + c.fp)))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.mcc, np.sqrt(c.mk * c.bm)))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(</span>
<span class="sd">        &gt;&gt;&gt;     c.acc, (c.tpr + c.c * (1 - c.fpr)) / (1 + c.c)))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(c.ppv, c.recall * c.prev / c.bias))</span>
<span class="sd">        &gt;&gt;&gt; assert np.all(np.isclose(</span>
<span class="sd">        &gt;&gt;&gt;    c.wracc, 4 * c.c * (c.tpr - c.fpr) / (1 + c.c) ** 2))</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">        &gt;&gt;&gt; confusions.draw_roc_curve()</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_tp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n_hit&#39;</span><span class="p">,</span> <span class="s1">&#39;n_true_pos&#39;</span><span class="p">},</span>
        <span class="s1">&#39;n_tn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n_reject&#39;</span><span class="p">,</span> <span class="s1">&#39;n_true_neg&#39;</span><span class="p">},</span>
        <span class="s1">&#39;n_fp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n_false_alarm&#39;</span><span class="p">,</span> <span class="s1">&#39;n_false_pos&#39;</span><span class="p">},</span>
        <span class="s1">&#39;n_fn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;n_false_neg&#39;</span><span class="p">},</span>
        <span class="c1"># -----</span>
        <span class="s1">&#39;rp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;real_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;prev&#39;</span><span class="p">,</span> <span class="s1">&#39;prevalence&#39;</span><span class="p">},</span>
        <span class="s1">&#39;rn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;real_neg&#39;</span><span class="p">},</span>
        <span class="s1">&#39;pp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pred_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">},</span>
        <span class="s1">&#39;pn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pred_neg&#39;</span><span class="p">},</span>
        <span class="c1"># -----</span>
        <span class="s1">&#39;cs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;class_odds&#39;</span><span class="p">,</span> <span class="s1">&#39;skew&#39;</span><span class="p">},</span>
        <span class="s1">&#39;cv&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;cost_ratio&#39;</span><span class="p">},</span>
        <span class="s1">&#39;cp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;cost_pos&#39;</span><span class="p">},</span>
        <span class="s1">&#39;cn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;cost_neg&#39;</span><span class="p">},</span>
        <span class="c1"># -----</span>
        <span class="s1">&#39;tp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;true_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;hit&#39;</span><span class="p">},</span>
        <span class="s1">&#39;tn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;true_neg&#39;</span><span class="p">,</span> <span class="s1">&#39;reject&#39;</span><span class="p">},</span>
        <span class="s1">&#39;fp&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;false_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;type1_error&#39;</span><span class="p">,</span> <span class="s1">&#39;false_alarm&#39;</span><span class="p">},</span>
        <span class="s1">&#39;fn&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;false_neg&#39;</span><span class="p">,</span> <span class="s1">&#39;type2_error&#39;</span><span class="p">,</span> <span class="s1">&#39;miss&#39;</span><span class="p">},</span>
        <span class="c1"># -----</span>
        <span class="s1">&#39;fpr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;false_pos_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;fallout&#39;</span><span class="p">},</span>
        <span class="s1">&#39;fnr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;false_neg_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;miss_rate&#39;</span><span class="p">},</span>
        <span class="s1">&#39;tpr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;true_pos_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">,</span> <span class="s1">&#39;sensitivity&#39;</span><span class="p">,</span> <span class="s1">&#39;hit_rate&#39;</span><span class="p">},</span>
        <span class="s1">&#39;tnr&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;true_neg_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;inv_recall, specificity&#39;</span><span class="p">},</span>
        <span class="c1"># -----</span>
        <span class="s1">&#39;tpa&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;true_pos_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_predict_value&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;ppv&#39;</span><span class="p">},</span>
        <span class="s1">&#39;tna&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;true_neg_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;neg_predict_value&#39;</span><span class="p">,</span> <span class="s1">&#39;inv_precision&#39;</span><span class="p">,</span> <span class="s1">&#39;npv&#39;</span><span class="p">},</span>
        <span class="c1"># -----</span>
        <span class="s1">&#39;mk&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;markedness&#39;</span><span class="p">,</span> <span class="s1">&#39;deltaP&#39;</span><span class="p">,</span> <span class="s1">&#39;r_P&#39;</span><span class="p">},</span>
        <span class="s1">&#39;bm&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;informedness&#39;</span><span class="p">,</span> <span class="s1">&#39;bookmaker_informedness&#39;</span><span class="p">,</span> <span class="s2">&quot;deltaP&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;r_R&#39;</span><span class="p">},</span>
        <span class="c1"># -----</span>
        <span class="s1">&#39;mcc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;matthews_correlation_coefficient&#39;</span><span class="p">},</span>
        <span class="s1">&#39;jacc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;jaccard_coefficient&#39;</span><span class="p">},</span>
        <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;rand_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;tea&#39;</span><span class="p">,</span> <span class="s1">&#39;ter&#39;</span><span class="p">},</span>
        <span class="s1">&#39;wracc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;weighted_relative_accuracy&#39;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># the same things are called by lots of different names</span>
    <span class="n">paper_alias</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;dtp&#39;</span><span class="p">,</span> <span class="s1">&#39;determinant&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">,</span> <span class="s1">&#39;liklihood-ratio&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;nlr&#39;</span><span class="p">,</span> <span class="s1">&#39;negative-liklihood-ratio&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;bmg&#39;</span><span class="p">,</span> <span class="s1">&#39;bookmarkG&#39;</span><span class="p">,</span> <span class="s1">&#39;bookmark_geometric_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;mcc?&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;evenness_R&#39;</span><span class="p">,</span> <span class="s1">&#39;PrevG2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;evenness_P&#39;</span><span class="p">,</span> <span class="s1">&#39;BiasG2&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;rh&#39;</span><span class="p">,</span> <span class="s1">&#39;real_harmonic_mean&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;ph&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_harminic_mean&#39;</span><span class="p">],</span>
    <span class="p">]</span>

    <span class="c1"># And they related to each other in interesting ways</span>
    <span class="n">paper_relations</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A + B + C + D&#39;</span><span class="p">],</span>
        <span class="s1">&#39;dtp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A * D - B * C&#39;</span><span class="p">],</span>
        <span class="s1">&#39;mk&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtp / (bias * (1 - bias))&#39;</span><span class="p">,</span> <span class="s1">&#39;dtp / biasG ** 2&#39;</span><span class="p">],</span>
        <span class="s1">&#39;bm&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtp / (prev * (1 - prev))&#39;</span><span class="p">],</span>
        <span class="s1">&#39;BiasG2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;bias * 1 - bias&#39;</span><span class="p">],</span>
        <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tpr / (1 - tnr)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;nlr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tnr / (1 - tpr)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;BMG&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtp / evenness_G&#39;</span><span class="p">],</span>
        <span class="s1">&#39;IBias&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;1 - Bias&#39;</span><span class="p">],</span>
        <span class="s1">&#39;etp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rp * pp&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_true_positives&#39;</span><span class="p">],</span>
        <span class="s1">&#39;etn&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rn * pn&#39;</span><span class="p">,</span> <span class="s1">&#39;expected_true_negatives&#39;</span><span class="p">],</span>
        <span class="s1">&#39;rh&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2 * rp * rn / (rp + rn)&#39;</span><span class="p">,</span> <span class="s1">&#39;real_harmonic_mean&#39;</span><span class="p">],</span>
        <span class="s1">&#39;ph&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;2 * pp * pn / (pp + pn)&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_harminic_mean&#39;</span><span class="p">],</span>
        <span class="s1">&#39;dp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tp - etp&#39;</span><span class="p">,</span> <span class="s1">&#39;dtp&#39;</span><span class="p">,</span> <span class="s1">&#39;-dtn&#39;</span><span class="p">,</span> <span class="s1">&#39;-(tn - etn)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;deltap&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dtp - dtn&#39;</span><span class="p">,</span> <span class="s1">&#39;2 * dp&#39;</span><span class="p">],</span>
        <span class="s1">&#39;kappa&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;deltap / (deltap + (fp + fn) / 2)&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># ROC Plot: tpr vs fpr</span>
    <span class="c1"># PN Plot: TP vs FP</span>

    <span class="n">minimizing_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fpr&#39;</span><span class="p">,</span> <span class="s1">&#39;fnr&#39;</span><span class="p">,</span> <span class="s1">&#39;fp&#39;</span><span class="p">,</span> <span class="s1">&#39;fn&#39;</span><span class="p">}</span>

    <span class="n">inv_aliases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">alias_key</span><span class="p">:</span> <span class="n">std_key</span>
        <span class="k">for</span> <span class="n">std_key</span><span class="p">,</span> <span class="n">alias_vals</span> <span class="ow">in</span> <span class="n">aliases</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">alias_key</span> <span class="ow">in</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">alias_vals</span><span class="p">,</span> <span class="p">{</span><span class="n">std_key</span><span class="p">})</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Scalars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Threshold based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Can be set to weight the cost of errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cp</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cn</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># def __nice__(self):</span>
    <span class="c1">#     return &#39;{}&#39;.format(cfms.n_samples)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">thresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span>

    <span class="c1"># ----</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; class ratio &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; ratio of cost of making a mistake&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span>

    <span class="c1"># -----</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; true positive probability &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; true negative probability &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; false positive probability &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; false negative probability &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>

    <span class="c1"># ----</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; real positive probability &quot;&quot;&quot;</span>
        <span class="c1"># return (self.tp + self.fn)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pos</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; real negative probability &quot;&quot;&quot;</span>
        <span class="c1"># return (self.fp + self.tn)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_neg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; predicted positive probability &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; predicted negative probability &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tn</span>

    <span class="c1"># ----</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fpr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; fallout, false positive rate &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_neg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fnr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; miss rate, false negative rate &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tpr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sensitivity, recall, hit rate, tpr &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tp</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tnr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; true negative rate, inverse recall &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_neg</span>

    <span class="c1"># ----</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tpa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; miss rate, false negative rate &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fp</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tna</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; negative predictive value, inverse precision &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tn</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_tn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fn</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># ----</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; bookmaker informedness &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnr</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; markedness &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpa</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tna</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># ---- other measures</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auc_trap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># per threshold trapazoidal auc metric</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; accuracy &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sqrd_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; squared error &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpr</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mcc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; matthews correlation coefficient</span>

<span class="sd">        Also true that:</span>
<span class="sd">            mcc == np.sqrt(self.bm * self.mk)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mcc_numer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tn</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span>
        <span class="n">mcc_denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">mcc</span> <span class="o">=</span> <span class="n">nan_to_num</span><span class="p">(</span><span class="n">mcc_numer</span> <span class="o">/</span> <span class="n">mcc_denom</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mcc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jacc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; jaccard coefficient &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tn</span><span class="p">)</span>
        <span class="c1"># return self.tp / (self.tp + self.fn + self.fp)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wracc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; weighted relative accuracy &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recall</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev</span>

    <span class="c1"># --- alias names currently needed for compatability</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">attrs</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">attrs</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">attrs</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">std_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_aliases</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">std_attr</span><span class="p">)</span>

    <span class="c1"># @property</span>
    <span class="c1"># def recall(self):</span>
    <span class="c1">#     return self.tpr</span>

    <span class="c1"># @property</span>
    <span class="c1"># def precision(self):</span>
    <span class="c1">#     return self.tpa</span>

    <span class="c1"># @property</span>
    <span class="c1"># def fallout(self):</span>
    <span class="c1">#     return self.fpr</span>

    <span class="c1"># --------------</span>
    <span class="c1"># Construtors</span>
    <span class="c1"># --------------</span>

<div class="viewcode-block" id="ConfusionMetrics.fit"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="c1"># must be binary</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[confusion] building confusion metrics.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[confusion]  * scores.shape=</span><span class="si">%r</span><span class="s1">, scores.dtype=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;[confusion]  * labels.shape=</span><span class="si">%r</span><span class="s1">, labels.dtype=</span><span class="si">%r</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">labels</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># sklearn has much faster implementation</span>
        <span class="c1"># n_fp - count the number of false positives with score &gt;= threshold[i]</span>
        <span class="c1"># n_tp - count the number of true positives with score &gt;= threshold[i]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">sklearn.metrics._ranking</span> <span class="k">import</span> <span class="n">_binary_clf_curve</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">sklearn.metrics.ranking</span> <span class="k">import</span> <span class="n">_binary_clf_curve</span>

        <span class="n">n_fp</span><span class="p">,</span> <span class="n">n_tp</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">_binary_clf_curve</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">n_pos</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">n_neg</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_pos</span>

        <span class="c1"># Scalars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pos</span> <span class="o">=</span> <span class="n">n_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_neg</span> <span class="o">=</span> <span class="n">n_neg</span>

        <span class="c1"># Threshold based</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">thresholds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tp</span> <span class="o">=</span> <span class="n">n_tp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fp</span> <span class="o">=</span> <span class="n">n_fp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fn</span> <span class="o">=</span> <span class="n">n_pos</span> <span class="o">-</span> <span class="n">n_tp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tn</span> <span class="o">=</span> <span class="n">n_neg</span> <span class="o">-</span> <span class="n">n_fp</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ConfusionMetrics.from_tp_and_tn_scores"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.from_tp_and_tn_scores">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_tp_and_tn_scores</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tp_scores</span><span class="p">,</span> <span class="n">tn_scores</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">tp_scores</span><span class="p">,</span> <span class="n">tn_scores</span><span class="p">])</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tp_scores</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tn_scores</span><span class="p">))</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1"># -------------------------------</span>
    <span class="c1"># Threshold-less Summary Measures</span>
    <span class="c1"># -------------------------------</span>

<div class="viewcode-block" id="ConfusionMetrics.get_ave_precision"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_ave_precision">[docs]</a>    <span class="k">def</span> <span class="nf">get_ave_precision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recall</span>
        <span class="n">recall_domain</span><span class="p">,</span> <span class="n">p_interp</span> <span class="o">=</span> <span class="n">interpolate_precision_recall</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p_interp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">p_interp</span><span class="o">.</span><span class="n">size</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The AUC is a standard measure used to evaluate a binary classifier and</span>
<span class="sd">          represents the probability that a random correct case will</span>
<span class="sd">          receive a higher score than a random incorrect case.</span>

<span class="sd">        References:</span>
<span class="sd">            https://en.wikipedia.org/wiki/Receiver_operating_characteristic#Area_under_the_curve</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: change name to represent it is a total measure</span>
        <span class="kn">import</span> <span class="nn">sklearn.metrics</span>

        <span class="k">return</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">auc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpr</span><span class="p">)</span>

    <span class="c1"># ---------------------</span>
    <span class="c1"># Threshold Choosers / Info</span>
    <span class="c1"># ---------------------</span>

<div class="viewcode-block" id="ConfusionMetrics.get_fpr_at_recall"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_fpr_at_recall">[docs]</a>    <span class="k">def</span> <span class="nf">get_fpr_at_recall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_recall</span><span class="p">):</span>
        <span class="n">indicies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recall</span> <span class="o">&gt;=</span> <span class="n">target_recall</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;no recall at target level&#39;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recall</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpr</span><span class="p">)</span>
        <span class="n">interp_fpr</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">target_recall</span><span class="p">)</span>
        <span class="c1"># # interpolate to target recall</span>
        <span class="c1"># right_index  = indicies[0]</span>
        <span class="c1"># right_recall = self.recall[right_index]</span>
        <span class="c1"># left_index   = right_index - 1</span>
        <span class="c1"># left_recall  = self.recall[left_index]</span>
        <span class="c1"># stepsize = right_recall - left_recall</span>
        <span class="c1"># alpha = (target_recall - left_recall) / stepsize</span>
        <span class="c1"># left_fpr   = self.fpr[left_index]</span>
        <span class="c1"># right_fpr  = self.fpr[right_index]</span>
        <span class="c1"># interp_fpp = (left_fpr * (1 - alpha)) + (right_fpr * (alpha))</span>
        <span class="k">return</span> <span class="n">interp_fpr</span></div>

<div class="viewcode-block" id="ConfusionMetrics.get_recall_at_fpr"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_recall_at_fpr">[docs]</a>    <span class="k">def</span> <span class="nf">get_recall_at_fpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_fpr</span><span class="p">):</span>
        <span class="n">indicies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpr</span> <span class="o">&gt;=</span> <span class="n">target_fpr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">indicies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;no false positives at target level&#39;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpr</span><span class="p">)</span>
        <span class="n">interp_tpr</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">target_fpr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interp_tpr</span></div>

<div class="viewcode-block" id="ConfusionMetrics.get_thresh_at_metric_max"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_thresh_at_metric_max">[docs]</a>    <span class="k">def</span> <span class="nf">get_thresh_at_metric_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        metric = &#39;mcc&#39;</span>
<span class="sd">        metric = &#39;fnr&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metric_values</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">metric_values</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># interpolated version</span>
            <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

            <span class="n">thresh</span><span class="p">,</span> <span class="n">max_value</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsubmax</span><span class="p">(</span><span class="n">metric_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thresh</span></div>

<div class="viewcode-block" id="ConfusionMetrics.get_thresh_at_metric"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_thresh_at_metric">[docs]</a>    <span class="k">def</span> <span class="nf">get_thresh_at_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a threshold for a binary classifier using a target metric and value</span>

<span class="sd">        Args:</span>
<span class="sd">            metric (str): name of metric like tpr or fpr</span>
<span class="sd">            value (float): corresponding numeric value</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: thresh</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m vtool.confusion get_thresh_at_metric</span>
<span class="sd">            python -m vtool.confusion --exec-interact_roc_factory --show</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; scores, labels = testdata_scores_labels()</span>
<span class="sd">            &gt;&gt;&gt; self = ConfusionMetrics().fit(scores, labels)</span>
<span class="sd">            &gt;&gt;&gt; metric = &#39;tpr&#39;</span>
<span class="sd">            &gt;&gt;&gt; value = .85</span>
<span class="sd">            &gt;&gt;&gt; thresh = self.get_thresh_at_metric(metric, value)</span>
<span class="sd">            &gt;&gt;&gt; print(&#39;%s = %r&#39; % (metric, value,))</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;thresh = %s&#39; % (str(thresh),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">            thresh = 22.5</span>

<span class="sd">        Ignore:</span>
<span class="sd">            metric = &#39;fpr&#39;</span>
<span class="sd">            value = 1e-4</span>
<span class="sd">            self = cfms</span>
<span class="sd">            maximize = False</span>

<span class="sd">        interpolate_replbounds(metric_values, self.thresholds, 0, maximize=maximize)</span>
<span class="sd">        interpolate_replbounds(metric_values, self.thresholds, 1e-4, maximize=maximize)</span>
<span class="sd">        interpolate_replbounds(metric_values, self.thresholds, 1e-3, maximize=maximize)</span>
<span class="sd">        interpolate_replbounds(metric_values, self.thresholds, 1e-2, maximize=maximize)</span>
<span class="sd">        interpolate_replbounds(metric_values, self.thresholds, 1e-2, maximize=maximize)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thresh_at_metric_max</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
        <span class="c1"># if value == &#39;min&#39;:</span>
        <span class="c1">#     return self.get_thresh_at_metric_min(metric)</span>
        <span class="c1"># TODO: Use interpoloation here and make tpr vs fpr a smooth funciton</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_aliases</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
        <span class="n">metric_values</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;fpr&#39;</span><span class="p">:</span>
            <span class="c1"># hack</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>
        <span class="c1"># maximize = metric not in self.minimizing_metrics</span>
        <span class="k">if</span> <span class="n">maximize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maximize</span> <span class="o">=</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;fpr&#39;</span><span class="p">}</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">interpolate_replbounds</span><span class="p">(</span>
            <span class="n">metric_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="n">maximize</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">thresh</span></div>

<div class="viewcode-block" id="ConfusionMetrics.get_metric_at_metric"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_metric_at_metric">[docs]</a>    <span class="k">def</span> <span class="nf">get_metric_at_metric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">get_metric</span><span class="p">,</span> <span class="n">at_metric</span><span class="p">,</span> <span class="n">at_value</span><span class="p">,</span> <span class="n">subindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tiebreaker</span><span class="o">=</span><span class="s1">&#39;maxthresh&#39;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the corresponding value of `get_metric` at a specific value of</span>
<span class="sd">        `at_metric`.</span>


<span class="sd">        get_metric = &#39;fpr&#39;</span>
<span class="sd">        at_metric = &#39;tpr&#39;</span>
<span class="sd">        at_value = .25</span>
<span class="sd">        self.rrr()</span>

<span class="sd">        self.get_metric_at_metric(&#39;fpr&#39;, &#39;tpr&#39;, .25)</span>
<span class="sd">        self.get_metric_at_metric(&#39;n_false_pos&#39;, &#39;tpr&#39;, .25)</span>
<span class="sd">        self.get_metric_at_metric(&#39;n_true_pos&#39;, &#39;tpr&#39;, .25)</span>

<span class="sd">        get_metric = &#39;n_true_pos&#39;</span>
<span class="sd">        at_metric = &#39;n_false_pos&#39;</span>
<span class="sd">        at_value = 0</span>
<span class="sd">        subindex = False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_at_metric</span><span class="p">(</span>
            <span class="n">at_metric</span><span class="p">,</span> <span class="n">at_value</span><span class="p">,</span> <span class="n">subindex</span><span class="o">=</span><span class="n">subindex</span><span class="p">,</span> <span class="n">tiebreaker</span><span class="o">=</span><span class="n">tiebreaker</span>
        <span class="p">)</span>
        <span class="n">get_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_metric_at_index</span><span class="p">(</span><span class="n">get_metric</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">get_value</span></div>

<div class="viewcode-block" id="ConfusionMetrics.get_index_at_metric"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_index_at_metric">[docs]</a>    <span class="k">def</span> <span class="nf">get_index_at_metric</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">at_metric</span><span class="p">,</span> <span class="n">at_value</span><span class="p">,</span> <span class="n">subindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tiebreaker</span><span class="o">=</span><span class="s1">&#39;maxthresh&#39;</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the index that is closet to the metric at a given value</span>

<span class="sd">        Args:</span>
<span class="sd">            tiebreaker (str): either &#39;minimize&#39; or &#39;maximize&#39;</span>
<span class="sd">                if &#39;maximize&#39;, then a larger threshold is considered better</span>
<span class="sd">                when resolving ambiguities. Otherwise a smaller thresh is</span>
<span class="sd">                better.</span>

<span class="sd">        Doctest:</span>
<span class="sd">            &gt;&gt;&gt; from vtool.confusion import *</span>
<span class="sd">            &gt;&gt;&gt; pat1 = [0, 0, 0, 0]</span>
<span class="sd">            &gt;&gt;&gt; pat2 = [0, 0, 1, 1]</span>
<span class="sd">            &gt;&gt;&gt; pat3 = [0, 1, 1, 1]</span>
<span class="sd">            &gt;&gt;&gt; pat4 = [1, 1, 1, 1]</span>
<span class="sd">            &gt;&gt;&gt; pats = [pat1, pat2, pat3, pat4]</span>
<span class="sd">            &gt;&gt;&gt; n = 4</span>
<span class="sd">            &gt;&gt;&gt; import itertools as it</span>
<span class="sd">            &gt;&gt;&gt; s = it.count(0)</span>
<span class="sd">            &gt;&gt;&gt; # Create places of ambiguitiy and unambiguity</span>
<span class="sd">            &gt;&gt;&gt; x = list(ub.flatten([[next(s)] * len(pat) for pat in pats for _ in range(n)]))</span>
<span class="sd">            &gt;&gt;&gt; y = list(ub.flatten([pat for pat in pats for _ in range(n)]))</span>
<span class="sd">            &gt;&gt;&gt; self = ConfusionMetrics().fit(x, y)</span>
<span class="sd">            &gt;&gt;&gt; at_metric = &#39;n_false_pos&#39;</span>
<span class="sd">            &gt;&gt;&gt; at_value = 0</span>
<span class="sd">            &gt;&gt;&gt; subindex = False</span>
<span class="sd">            &gt;&gt;&gt; idx1 = self.get_index_at_metric(at_metric, at_value, subindex=False, tiebreaker=&#39;minthresh&#39;)</span>
<span class="sd">            &gt;&gt;&gt; idx2 = self.get_index_at_metric(at_metric, at_value, subindex=False, tiebreaker= &#39;maxthresh&#39;)</span>
<span class="sd">            &gt;&gt;&gt; assert idx1 == 3</span>
<span class="sd">            &gt;&gt;&gt; assert idx2 == 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">at_arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at_metric</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at_value</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;maximize&#39;</span><span class="p">}:</span>
            <span class="n">at_value</span> <span class="o">=</span> <span class="n">at_arr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">at_value</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;minimize&#39;</span><span class="p">}:</span>
            <span class="n">at_value</span> <span class="o">=</span> <span class="n">at_arr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="c1"># Find point closest to the value</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">at_arr</span> <span class="o">-</span> <span class="n">at_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subindex</span><span class="p">:</span>
            <span class="c1"># TODO: need to be able to figure out how to correctly break ties</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;fixme use argsubminima2 and then other stuff&#39;</span><span class="p">)</span>
            <span class="n">submin_x</span><span class="p">,</span> <span class="n">submin_y</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">argsubmin2</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">submin_x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># idx = distance.argmin()</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">distance</span> <span class="o">==</span> <span class="n">distance</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># If len(idxs) is bigger than 0 it is ambiguous</span>
            <span class="k">if</span> <span class="n">tiebreaker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">idxs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tiebreaker</span> <span class="o">==</span> <span class="s1">&#39;maxthresh&#39;</span><span class="p">:</span>
                    <span class="c1"># If we want to maximize the thresh then take leftmost</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">tiebreaker</span> <span class="o">==</span> <span class="s1">&#39;minthresh&#39;</span><span class="p">:</span>
                    <span class="c1"># If we want to minimize the thresh then take rightmost</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;tiebreaker = </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tiebreaker</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">idx</span></div>

<div class="viewcode-block" id="ConfusionMetrics.get_metric_at_index"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_metric_at_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_metric_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">subindex</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subindex</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">subindex</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">linear_interpolation</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">subindex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="ConfusionMetrics.get_metric_at_thresh"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.get_metric_at_thresh">[docs]</a>    <span class="k">def</span> <span class="nf">get_metric_at_thresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            metric (str): name of a metric</span>
<span class="sd">            thresh (float): desired threshold</span>

<span class="sd">        Returns:</span>
<span class="sd">            float : value - metric value</span>

<span class="sd">        CommandLine:</span>
<span class="sd">            python -m vtool.confusion --exec-get_metric_at_threshold</span>

<span class="sd">        Ignore:</span>
<span class="sd">            &gt;&gt;&gt; self = cfms</span>
<span class="sd">            &gt;&gt;&gt; metric = &#39;fpr&#39;</span>
<span class="sd">            &gt;&gt;&gt; thresh = 0</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">            &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">            &gt;&gt;&gt; scores, labels = testdata_scores_labels()</span>
<span class="sd">            &gt;&gt;&gt; self = ConfusionMetrics().fit(scores, labels)</span>
<span class="sd">            &gt;&gt;&gt; metric = &#39;tpr&#39;</span>
<span class="sd">            &gt;&gt;&gt; thresh = .8</span>
<span class="sd">            &gt;&gt;&gt; thresh = [0, .1, .9, 1.0]</span>
<span class="sd">            &gt;&gt;&gt; value = self.get_metric_at_thresh(metric, thresh)</span>
<span class="sd">            &gt;&gt;&gt; result = (&#39;(None, None) = %s&#39; % (str((None, None)),))</span>
<span class="sd">            &gt;&gt;&gt; print(result)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">was_scalar</span> <span class="o">=</span> <span class="n">ut</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">was_scalar</span><span class="p">:</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="p">[</span><span class="n">thresh</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">thresh</span><span class="p">)</span>
        <span class="c1"># Assert decreasing</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span>
        <span class="n">thresh_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">thresh_</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">sorter</span><span class="o">=</span><span class="n">sortx</span><span class="p">)</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="n">sortx</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="c1"># index_list = [np.where(self.thresholds &lt;= t)[0][0] for t in thresh]</span>
        <span class="c1"># sortx[r]</span>
        <span class="c1"># index_list = []</span>
        <span class="c1"># for t in thresh:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         index = np.nonzero(self.thresholds &lt;= t)[0][0]</span>
        <span class="c1">#     except IndexError:</span>
        <span class="c1">#         print(&#39;warning: index error in get_metric_at_thresh t=%r&#39; % (t,))</span>
        <span class="c1">#         index = len(self.thresholds) - 1</span>
        <span class="c1">#     index_list.append(index)</span>
        <span class="c1"># # value = self.__dict__[metric][index]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">index_list</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">was_scalar</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span></div>

    <span class="c1"># --------------</span>
    <span class="c1"># Visualizations</span>
    <span class="c1"># --------------</span>

<div class="viewcode-block" id="ConfusionMetrics.draw_roc_curve"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.draw_roc_curve">[docs]</a>    <span class="k">def</span> <span class="nf">draw_roc_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">draw_roc_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfusionMetrics.draw_precision_recall_curve"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.draw_precision_recall_curve">[docs]</a>    <span class="k">def</span> <span class="nf">draw_precision_recall_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nSamples</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recall</span>
        <span class="n">recall_domain</span><span class="p">,</span> <span class="n">p_interp</span> <span class="o">=</span> <span class="n">interpolate_precision_recall</span><span class="p">(</span>
            <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">nSamples</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">draw_precision_recall_curve</span><span class="p">(</span><span class="n">recall_domain</span><span class="p">,</span> <span class="n">p_interp</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfusionMetrics.plot_vs"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.plot_vs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_vs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_metric</span><span class="p">,</span> <span class="n">y_metric</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        x_metric = &#39;thresholds&#39;</span>
<span class="sd">        y_metric = &#39;fpr&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="c1"># pt.qtensure()</span>
        <span class="c1"># xdata = self.thresholds</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_metric</span><span class="p">)</span>
        <span class="n">ydata_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_metric</span><span class="p">)]</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span>
            <span class="n">ydata_list</span><span class="p">,</span>
            <span class="c1"># label_list=[y_metric],</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="n">x_metric</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="n">y_metric</span><span class="p">,</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ConfusionMetrics.plot_metrics"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.plot_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">plot_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;mcc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;acc&#39;</span><span class="p">,</span>
            <span class="s1">&#39;auc_trap&#39;</span>
            <span class="c1"># &#39;tpa&#39;, &#39;tpr&#39;,</span>
            <span class="c1"># &#39;acc&#39;, &#39;sqrd_error&#39;,</span>
            <span class="c1"># &#39;auc_trap&#39;,</span>
            <span class="c1"># &#39;mk&#39;, &#39;bm&#39;</span>
        <span class="p">]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;fnr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fpr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tpr&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tnr&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span>
        <span class="n">ydata_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="n">xdata</span><span class="p">,</span>
            <span class="n">ydata_list</span><span class="p">,</span>
            <span class="n">label_list</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span>
            <span class="n">use_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ConfusionMetrics.show_mcc"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.ConfusionMetrics.show_mcc">[docs]</a>    <span class="k">def</span> <span class="nf">show_mcc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mcc</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;MCC&#39;</span>
        <span class="p">)</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="interpolate_replbounds"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.interpolate_replbounds">[docs]</a><span class="k">def</span> <span class="nf">interpolate_replbounds</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">maximize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xdata = np.array([.1, .2, .3, .4, .5])</span>
<span class="sd">    ydata = np.array([.1, .2, .3, .4, .5])</span>
<span class="sd">    pt = .35</span>

<span class="sd">    FIXME:</span>
<span class="sd">        if duplicate xdata is given bad things happen.</span>
<span class="sd">    BUG:</span>
<span class="sd">        in scipy.interpolate.interp1d</span>
<span class="sd">        If there is a duplicate xdata, then assume_sorted=False will</span>
<span class="sd">        sort ydata by xdata, but xdata should retain its initial ordering</span>
<span class="sd">        in places of ambuguity. Currently it does not.</span>
<span class="sd">    Args:</span>
<span class="sd">        xdata (ndarray):</span>
<span class="sd">        ydata (ndarray):</span>
<span class="sd">        pt (ndarray):</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: interp_vals</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.confusion --exec-interpolate_replbounds</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; scores, labels = testdata_scores_labels()</span>
<span class="sd">        &gt;&gt;&gt; self = ConfusionMetrics().fit(scores, labels)</span>
<span class="sd">        &gt;&gt;&gt; xdata = self.tpr</span>
<span class="sd">        &gt;&gt;&gt; ydata = self.thresholds</span>
<span class="sd">        &gt;&gt;&gt; pt = 1.0</span>
<span class="sd">        &gt;&gt;&gt; #xdata = self.fpr</span>
<span class="sd">        &gt;&gt;&gt; #ydata = self.thresholds</span>
<span class="sd">        &gt;&gt;&gt; #pt = 0.0</span>
<span class="sd">        &gt;&gt;&gt; thresh = interpolate_replbounds(xdata, ydata, pt, maximize=True)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;thresh = %r&#39; % (thresh,))</span>
<span class="sd">        &gt;&gt;&gt; thresh = interpolate_replbounds(xdata, ydata, pt, maximize=False)</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;thresh = %r&#39; % (thresh,))</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; xdata = np.array([0.7,  0.8,  0.8,  0.9,  0.9, 0.9])</span>
<span class="sd">        &gt;&gt;&gt; ydata = np.array([34,    26,   23,   22,   19,  17])</span>
<span class="sd">        &gt;&gt;&gt; pt = np.array([.85, 1.0, -1.0])</span>
<span class="sd">        &gt;&gt;&gt; interp_vals = interpolate_replbounds(xdata, ydata, pt)</span>
<span class="sd">        &gt;&gt;&gt; result = (&#39;interp_vals = %s&#39; % (str(interp_vals),))</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        interp_vals = [ 22.5  17.   34. ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ut</span><span class="o">.</span><span class="n">issorted</span><span class="p">(</span><span class="n">xdata</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ut</span><span class="o">.</span><span class="n">issorted</span><span class="p">(</span><span class="n">xdata</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;need to sort xdata and ydata in function&#39;</span><span class="p">)</span>
            <span class="n">sortx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xdata</span><span class="p">)),</span> <span class="n">xdata</span><span class="p">]))</span>
            <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">sortx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">is_scalar</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">ub</span><span class="o">.</span><span class="n">iterable</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="c1"># print(&#39;----&#39;)</span>
    <span class="c1"># print(&#39;xdata = %r&#39; % (xdata,))</span>
    <span class="c1"># print(&#39;ydata = %r&#39; % (ydata,))</span>
    <span class="k">if</span> <span class="n">is_scalar</span><span class="p">:</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt</span><span class="p">])</span>
    <span class="n">minval</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">maxval</span> <span class="o">=</span> <span class="n">xdata</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">argx_min_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">xdata</span> <span class="o">==</span> <span class="n">minval</span><span class="p">)</span>
    <span class="n">argx_max_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">xdata</span> <span class="o">==</span> <span class="n">maxval</span><span class="p">)</span>
    <span class="n">argx_min</span> <span class="o">=</span> <span class="n">argx_min_list</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">argx_max</span> <span class="o">=</span> <span class="n">argx_max_list</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">lower_mask</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&lt;</span> <span class="n">xdata</span><span class="p">[</span><span class="n">argx_min</span><span class="p">]</span>
    <span class="n">upper_mask</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&gt;</span> <span class="n">xdata</span><span class="p">[</span><span class="n">argx_max</span><span class="p">]</span>
    <span class="n">interp_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">lower_mask</span><span class="p">,</span> <span class="n">upper_mask</span><span class="p">)</span>
    <span class="c1"># if isinstance(pt, np.ndarray):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">ydata</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">interp_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">interp_vals</span><span class="p">[</span><span class="n">lower_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ydata</span><span class="p">[</span><span class="n">argx_min</span><span class="p">]</span>
    <span class="n">interp_vals</span><span class="p">[</span><span class="n">upper_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ydata</span><span class="p">[</span><span class="n">argx_max</span><span class="p">]</span>

    <span class="c1"># TODO: fix duplicate values depending on if higher or lower numbers are</span>
    <span class="c1"># desirable</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Grouping should be ok because xdata should be sorted</span>
        <span class="c1"># therefore groupxs are consecutive</span>
        <span class="kn">import</span> <span class="nn">vtool</span> <span class="k">as</span> <span class="nn">vt</span>

        <span class="n">unique_vals</span><span class="p">,</span> <span class="n">groupxs</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">group_indices</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span>
        <span class="n">grouped_ydata</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">apply_grouping</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">groupxs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maximize</span><span class="p">:</span>
            <span class="n">sub_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ys</span><span class="p">)]</span> <span class="k">for</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groupxs</span><span class="p">,</span> <span class="n">grouped_ydata</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sub_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">ys</span><span class="p">)]</span> <span class="k">for</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groupxs</span><span class="p">,</span> <span class="n">grouped_ydata</span><span class="p">)]</span>
        <span class="n">sub_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sub_idxs</span><span class="p">)</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="n">sub_idxs</span><span class="p">]</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">ydata</span><span class="p">[</span><span class="n">sub_idxs</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">interp_mask</span><span class="p">):</span>
        <span class="c1"># FIXME: allow assume_sorted = False</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">interp_vals</span><span class="p">[</span><span class="n">interp_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">interp_mask</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">is_scalar</span><span class="p">:</span>
        <span class="n">interp_vals</span> <span class="o">=</span> <span class="n">interp_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># interpolate to target recall</span>
    <span class="c1"># right_index  = indicies[0]</span>
    <span class="c1"># right_recall = self.recall[right_index]</span>
    <span class="c1"># left_index   = right_index - 1</span>
    <span class="c1"># left_recall  = self.recall[left_index]</span>
    <span class="c1"># stepsize = right_recall - left_recall</span>
    <span class="c1"># alpha = (target_recall - left_recall) / stepsize</span>
    <span class="c1"># left_fpr   = self.fpr[left_index]</span>
    <span class="c1"># right_fpr  = self.fpr[right_index]</span>
    <span class="c1"># interp_fpp = (left_fpr * (1 - alpha)) + (right_fpr * (alpha))</span>
    <span class="k">return</span> <span class="n">interp_vals</span></div>


<div class="viewcode-block" id="interpolate_precision_recall"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.interpolate_precision_recall">[docs]</a><span class="k">def</span> <span class="nf">interpolate_precision_recall</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">nSamples</span><span class="o">=</span><span class="mi">11</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates precision as a function of recall p_{interp}(r)</span>

<span class="sd">    Reduce wiggles in average precision curve by taking interpolated values</span>
<span class="sd">    along a uniform sample.</span>

<span class="sd">    References:</span>
<span class="sd">        http://en.wikipedia.org/wiki/Information_retrieval#Average_precision</span>
<span class="sd">        http://en.wikipedia.org/wiki/Information_retrieval#Mean_Average_precision</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.confusion --test-interpolate_precision_recall --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # ENABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; scores, labels = testdata_scores_labels()</span>
<span class="sd">        &gt;&gt;&gt; nSamples = 11</span>
<span class="sd">        &gt;&gt;&gt; confusions = ConfusionMetrics().fit(scores, labels)</span>
<span class="sd">        &gt;&gt;&gt; precision = confusions.precision</span>
<span class="sd">        &gt;&gt;&gt; recall = confusions.recall</span>
<span class="sd">        &gt;&gt;&gt; recall_domain, p_interp = interpolate_precision_recall(confusions.precision, recall, nSamples=11)</span>
<span class="sd">        &gt;&gt;&gt; result = ub.repr2(p_interp, precision=1, with_dtype=True)</span>
<span class="sd">        &gt;&gt;&gt; print(result)</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">        &gt;&gt;&gt; draw_precision_recall_curve(recall_domain, p_interp)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">        np.array([ 1. ,  1. ,  1. ,  1. ,  1. ,  1. ,  1. ,  0.9,  0.9,  0.8,  0.6], dtype=np.float64)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">precision</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">recall_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nSamples</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># normal interpolation</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
            <span class="n">recall</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">precision</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">p_interp</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">recall_domain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Pascal interpolation</span>
        <span class="c1"># candidate_masks = recall &gt;= recall_domain[:, None]</span>
        <span class="c1"># candidates_idxs_ = [np.where(mask)[0] for mask in candidate_masks]</span>
        <span class="c1"># chosen_idx = [-1 if len(idxs) == 0 else idxs.min() for idxs in  candidates_idxs_]</span>
        <span class="c1"># p_interp = precision[chosen_idx]</span>
        <span class="k">def</span> <span class="nf">p_interp</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">precision_candidates</span> <span class="o">=</span> <span class="n">precision</span><span class="p">[</span><span class="n">recall</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">precision_candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">precision_candidates</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">p_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p_interp</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recall_domain</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">recall_domain</span><span class="p">,</span> <span class="n">p_interp</span></div>


<div class="viewcode-block" id="interact_roc_factory"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.interact_roc_factory">[docs]</a><span class="k">def</span> <span class="nf">interact_roc_factory</span><span class="p">(</span><span class="n">confusions</span><span class="p">,</span> <span class="n">target_tpr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_operating_point</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        confusions (Confusions):</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.confusion --exec-interact_roc_factory --show</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; scores, labels = testdata_scores_labels()</span>
<span class="sd">        &gt;&gt;&gt; print(&#39;scores = %r&#39; % (scores,))</span>
<span class="sd">        &gt;&gt;&gt; confusions = ConfusionMetrics().fit(scores, labels)</span>
<span class="sd">        &gt;&gt;&gt; print(ut.make_csv_table(</span>
<span class="sd">        &gt;&gt;&gt;   [confusions.fpr, confusions.tpr, confusions.thresholds],</span>
<span class="sd">        &gt;&gt;&gt;   [&#39;fpr&#39;, &#39;tpr&#39;, &#39;thresh&#39;]))</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">        &gt;&gt;&gt; ROCInteraction = interact_roc_factory(confusions, target_tpr=.4, show_operating_point=True)</span>
<span class="sd">        &gt;&gt;&gt; inter = ROCInteraction()</span>
<span class="sd">        &gt;&gt;&gt; inter.show_page()</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(--show)</span>
<span class="sd">        &gt;&gt;&gt; import wbia.plottool as pt</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">wbia.plottool.abstract_interaction</span> <span class="k">import</span> <span class="n">AbstractInteraction</span>

    <span class="k">class</span> <span class="nc">ROCInteraction</span><span class="p">(</span><span class="n">AbstractInteraction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        References:</span>
<span class="sd">            http://scipy-central.org/item/38/1/roc-curve-demo</span>

<span class="sd">        Notes:</span>
<span class="sd">            Sensitivity = true positive rate</span>
<span class="sd">            Specificity = true negative rate</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ROC Interact&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ROCInteraction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">confusions</span> <span class="o">=</span> <span class="n">confusions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_fpr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_operating_point</span> <span class="o">=</span> <span class="n">show_operating_point</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">static_plot</span><span class="p">(</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># print(&#39;ROC Interact2&#39;)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thresholds&#39;</span><span class="p">,</span> <span class="n">confusions</span><span class="o">.</span><span class="n">thresholds</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show_operating_point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;show_operating_point&#39;</span><span class="p">,</span> <span class="n">show_operating_point</span>
            <span class="p">)</span>
            <span class="n">confusions</span><span class="o">.</span><span class="n">draw_roc_curve</span><span class="p">(</span>
                <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span> <span class="n">target_tpr</span><span class="o">=</span><span class="n">target_tpr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnum</span><span class="p">,</span> <span class="n">pnum</span><span class="p">):</span>
            <span class="c1"># print(&#39;ROC Interact3&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static_plot</span><span class="p">(</span>
                <span class="n">fnum</span><span class="p">,</span>
                <span class="n">pnum</span><span class="p">,</span>
                <span class="n">target_fpr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_fpr</span><span class="p">,</span>
                <span class="n">show_operating_point</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">show_operating_point</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">on_click_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">ex</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_fpr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_page</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">on_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
            <span class="c1"># FIXME: blit</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># print(&#39;Dragging &#39; + str(event.x) + &#39; &#39; + str(event.y))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_fpr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_page</span><span class="p">()</span>
                <span class="c1"># self.draw()</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">inaxes</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>
                    <span class="c1"># [blit(ax) event.canvas.figure.axes]</span>

    <span class="k">return</span> <span class="n">ROCInteraction</span></div>


<div class="viewcode-block" id="draw_roc_curve"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.draw_roc_curve">[docs]</a><span class="k">def</span> <span class="nf">draw_roc_curve</span><span class="p">(</span>
    <span class="n">fpr</span><span class="p">,</span>
    <span class="n">tpr</span><span class="p">,</span>
    <span class="n">fnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">target_tpr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_fpr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">thresholds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">show_operating_point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        fpr (?):</span>
<span class="sd">        tpr (?):</span>
<span class="sd">        fnum (int):  figure number(default = None)</span>
<span class="sd">        pnum (tuple):  plot number(default = None)</span>
<span class="sd">        marker (str): (default = &#39;-x&#39;)</span>
<span class="sd">        target_tpr (None): (default = None)</span>
<span class="sd">        target_fpr (None): (default = None)</span>
<span class="sd">        thresholds (None): (default = None)</span>
<span class="sd">        color (None): (default = None)</span>
<span class="sd">        show_operating_point (bool): (default = False)</span>

<span class="sd">    CommandLine:</span>
<span class="sd">        python -m vtool.confusion --exec-draw_roc_curve --show --lightbg</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # DISABLE_DOCTEST</span>
<span class="sd">        &gt;&gt;&gt; from vtool.confusion import *  # NOQA</span>
<span class="sd">        &gt;&gt;&gt; scores, labels = testdata_scores_labels()</span>
<span class="sd">        &gt;&gt;&gt; confusions = ConfusionMetrics().fit(scores, labels)</span>
<span class="sd">        &gt;&gt;&gt; fpr = confusions.fpr</span>
<span class="sd">        &gt;&gt;&gt; tpr = confusions.tpr</span>
<span class="sd">        &gt;&gt;&gt; thresholds = confusions.thresholds</span>
<span class="sd">        &gt;&gt;&gt; fnum = None</span>
<span class="sd">        &gt;&gt;&gt; pnum = None</span>
<span class="sd">        &gt;&gt;&gt; marker = &#39;x&#39;</span>
<span class="sd">        &gt;&gt;&gt; target_tpr = .85</span>
<span class="sd">        &gt;&gt;&gt; target_fpr = None</span>
<span class="sd">        &gt;&gt;&gt; color = None</span>
<span class="sd">        &gt;&gt;&gt; show_operating_point = True</span>
<span class="sd">        &gt;&gt;&gt; draw_roc_curve(fpr, tpr, fnum, pnum, marker, target_tpr, target_fpr,</span>
<span class="sd">        &gt;&gt;&gt;   thresholds, color, show_operating_point)</span>
<span class="sd">        &gt;&gt;&gt; ut.show_if_requested()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>
    <span class="kn">import</span> <span class="nn">sklearn.metrics</span>

    <span class="k">if</span> <span class="n">fnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fnum</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">next_fnum</span><span class="p">()</span>

    <span class="c1"># if color is None:</span>
    <span class="c1">#     color = (0.4, 1.0, 0.4) if pt.is_default_dark_bg() else  (0.1, 0.4, 0.4)</span>

    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>

    <span class="n">title_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">target_fpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># func = scipy.interpolate.interp1d(fpr, tpr, kind=&#39;linear&#39;, assume_sorted=False)</span>
        <span class="c1"># func = scipy.interpolate.interp1d(xdata, ydata, kind=&#39;nearest&#39;, assume_sorted=False)</span>
        <span class="c1"># interp_vals[interp_mask] = func(pt[interp_mask])</span>
        <span class="n">target_fpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">target_fpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">interp_tpr</span> <span class="o">=</span> <span class="n">interpolate_replbounds</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">target_fpr</span><span class="p">)</span>
        <span class="n">choice_tpr</span> <span class="o">=</span> <span class="n">interp_tpr</span>
        <span class="n">choice_fpr</span> <span class="o">=</span> <span class="n">target_fpr</span>
    <span class="k">elif</span> <span class="n">target_tpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">target_tpr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">interp_fpr</span> <span class="o">=</span> <span class="n">interpolate_replbounds</span><span class="p">(</span><span class="n">tpr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">,</span> <span class="n">target_tpr</span><span class="p">)</span>
        <span class="n">choice_tpr</span> <span class="o">=</span> <span class="n">target_tpr</span>
        <span class="n">choice_fpr</span> <span class="o">=</span> <span class="n">interp_fpr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">choice_tpr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">choice_fpr</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">choice_fpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">choice_thresh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">thresholds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tpr</span> <span class="o">&gt;=</span> <span class="n">choice_tpr</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">choice_thresh</span> <span class="o">=</span> <span class="n">thresholds</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># percent = ut.scalar_str(choice_tpr * 100).split(&#39;.&#39;)[0]</span>
        <span class="c1"># title_suffix = &#39;, FPR%s=%05.2f%%&#39; % (percent, choice_fpr)</span>
        <span class="n">title_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">show_operating_point</span><span class="p">:</span>
            <span class="n">title_suffix</span> <span class="o">=</span> <span class="s1">&#39;, fpr=</span><span class="si">%.2f</span><span class="s1">, tpr=</span><span class="si">%.2f</span><span class="s1">, thresh=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">choice_fpr</span><span class="p">,</span>
                <span class="n">choice_tpr</span><span class="p">,</span>
                <span class="n">choice_thresh</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">title_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># if recall_domain is None:</span>
    <span class="c1">#    ave_p = np.nan</span>
    <span class="c1"># else:</span>
    <span class="c1">#    ave_p = p_interp.sum() / p_interp.size</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Receiver operating characteristic&#39;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39; (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;AUC=</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roc_auc</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; AUC=</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roc_auc</span><span class="p">,)</span>

    <span class="n">title</span> <span class="o">+=</span> <span class="n">title_suffix</span>

    <span class="n">label_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
        <span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="p">]</span>

    <span class="n">pt</span><span class="o">.</span><span class="n">multi_plot</span><span class="p">(</span>
        <span class="n">fpr</span><span class="p">,</span>
        <span class="p">[</span><span class="n">tpr</span><span class="p">],</span>
        <span class="n">label_list</span><span class="o">=</span><span class="n">label_list</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span>
        <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># pt.plot2(fpr, tpr, marker=marker,</span>
    <span class="c1">#          x_label=&#39;False Positive Rate&#39;,</span>
    <span class="c1">#          y_label=&#39;True Positive Rate&#39;,</span>
    <span class="c1">#          unitbox=True, flipx=False, color=color, fnum=fnum, pnum=pnum,</span>
    <span class="c1">#          title=title)</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># Interp does not work right because of duplicate values</span>
        <span class="c1"># in xdomain</span>
        <span class="n">line_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="c1"># np.append([np.inf], np.diff(fpr)) &gt; 0</span>
        <span class="c1"># np.append([np.inf], np.diff(tpr)) &gt; 0</span>
        <span class="n">unique_tpr_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tpr</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">unique_fpr_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">fpr</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">line_</span><span class="p">,</span>
            <span class="n">interpolate_replbounds</span><span class="p">(</span><span class="n">fpr</span><span class="p">[</span><span class="n">unique_fpr_idxs</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="n">unique_fpr_idxs</span><span class="p">],</span> <span class="n">line_</span><span class="p">),</span>
            <span class="s1">&#39;b-x&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">interpolate_replbounds</span><span class="p">(</span><span class="n">tpr</span><span class="p">[</span><span class="n">unique_tpr_idxs</span><span class="p">],</span> <span class="n">fpr</span><span class="p">[</span><span class="n">unique_tpr_idxs</span><span class="p">],</span> <span class="n">line_</span><span class="p">),</span>
            <span class="n">line_</span><span class="p">,</span>
            <span class="s1">&#39;r-x&#39;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">choice_fpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">choice_fpr</span><span class="p">,</span> <span class="n">choice_tpr</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">pt</span><span class="o">.</span><span class="n">PINK</span><span class="p">)</span></div>


<div class="viewcode-block" id="draw_precision_recall_curve"><a class="viewcode-back" href="../../vtool.html#vtool.confusion.draw_precision_recall_curve">[docs]</a><span class="k">def</span> <span class="nf">draw_precision_recall_curve</span><span class="p">(</span>
    <span class="n">recall_domain</span><span class="p">,</span> <span class="n">p_interp</span><span class="p">,</span> <span class="n">title_pref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fnum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pnum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="kn">import</span> <span class="nn">wbia.plottool</span> <span class="k">as</span> <span class="nn">pt</span>

    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span> <span class="k">if</span> <span class="n">pt</span><span class="o">.</span><span class="n">is_default_dark_bg</span><span class="p">()</span> <span class="k">else</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">recall_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">recall_domain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">p_interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">if</span> <span class="n">recall_domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ave_p</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>  <span class="c1"># np.nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ave_p</span> <span class="o">=</span> <span class="n">p_interp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">p_interp</span><span class="o">.</span><span class="n">size</span>

    <span class="n">pt</span><span class="o">.</span><span class="n">plot2</span><span class="p">(</span>
        <span class="n">recall_domain</span><span class="p">,</span>
        <span class="n">p_interp</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o--&#39;</span><span class="p">,</span>
        <span class="n">x_label</span><span class="o">=</span><span class="s1">&#39;recall&#39;</span><span class="p">,</span>
        <span class="n">y_label</span><span class="o">=</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span>
        <span class="n">unitbox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">flipx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
        <span class="n">fnum</span><span class="o">=</span><span class="n">fnum</span><span class="p">,</span>
        <span class="n">pnum</span><span class="o">=</span><span class="n">pnum</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Interplated Precision Vs Recall</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;avep = </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ave_p</span><span class="p">,</span>
    <span class="p">)</span></div>
    <span class="c1"># print(&#39;Interplated Precision&#39;)</span>
    <span class="c1"># print(ub.repr2(list(zip(recall_domain, p_interp))))</span>
    <span class="c1"># fig.show()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CommandLine:</span>
<span class="sd">        xdoctest -m vtool.confusion</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">xdoctest</span>

    <span class="n">xdoctest</span><span class="o">.</span><span class="n">doctest_module</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">wbia-vtool</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../vtool.html">vtool package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Wild Me.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>